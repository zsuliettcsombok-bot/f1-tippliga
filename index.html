<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>F1 2026 Tipp Liga</title>
  <style>
    :root{
      --bg1:#0b0b0f;
      --bg2:#2a0000;
      --card:rgba(0,0,0,.45);
      --border:rgba(255,255,255,.10);
      --text:#f3f3f3;
      --muted:rgba(255,255,255,.70);
      --red:#d8232a;
      --red2:#9b0000;
      --btn:#b10f12;
      --btn2:#e51f26;
      --ok:#1fbf6b;
      --warn:#ffb020;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 25% 15%, rgba(216,35,42,.35), transparent 60%),
        radial-gradient(900px 500px at 75% 85%, rgba(216,35,42,.20), transparent 60%),
        linear-gradient(135deg, var(--bg2), var(--bg1));
      min-height:100vh;
    }
    .topbar{
      position:sticky; top:0; z-index:10;
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:14px 18px;
      background:linear-gradient(180deg, rgba(0,0,0,.70), rgba(0,0,0,.35));
      border-bottom:1px solid var(--border);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; gap:10px; align-items:center; font-weight:800; letter-spacing:.4px;}
    .pill{
      width:38px;height:38px;border-radius:999px;
      background:linear-gradient(135deg, var(--red2), var(--red));
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 8px 22px rgba(0,0,0,.35);
      font-weight:900;
    }
    .nav{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .nav a{
      text-decoration:none; color:var(--text);
      padding:10px 14px; border-radius:14px;
      background:rgba(0,0,0,.35);
      border:1px solid var(--border);
      font-weight:700;
    }
    .nav a.active{background:rgba(216,35,42,.22); border-color:rgba(216,35,42,.35)}
    .wrap{max-width:1200px; margin:24px auto; padding:0 16px}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 18px 44px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .card-h{
      padding:18px 18px 14px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, rgba(216,35,42,.16), transparent);
    }
    .card-h h2{margin:0;font-size:22px}
    .card-b{padding:18px}
    .row{display:flex; gap:14px; flex-wrap:wrap}
    .col{flex:1; min-width:280px}
    .btn{
      cursor:pointer; border:none;
      padding:12px 14px; border-radius:14px;
      color:white; font-weight:800;
      background:linear-gradient(135deg, var(--btn), var(--btn2));
      box-shadow:0 12px 26px rgba(0,0,0,.35);
      display:inline-flex; gap:10px; align-items:center;
    }
    .btn.secondary{background:rgba(0,0,0,.35); border:1px solid var(--border); box-shadow:none; color:var(--text);}
    .btn.small{padding:10px 12px; border-radius:12px; font-weight:800}
    .muted{color:var(--muted)}
    .status{
      margin-top:14px; padding:12px 14px;
      border-radius:14px; border:1px solid var(--border);
      background:rgba(0,0,0,.25);
      display:flex; gap:10px; align-items:center;
      min-height:44px;
    }
    .status .dot{width:10px;height:10px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:#ff3b3b}
    .foot{opacity:.7; text-align:center; padding:18px 10px 30px; font-size:13px;}

    .list{display:grid; gap:10px;}
    .item{
      padding:12px 14px; border-radius:14px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.25);
      display:flex; justify-content:space-between;
      gap:10px; align-items:center;
    }
    .item b{font-size:15px}
    .tag{
      font-size:12px;
      padding:6px 10px; border-radius:999px;
      background:rgba(216,35,42,.22);
      border:1px solid rgba(216,35,42,.35);
      color:var(--text);
      white-space:nowrap;
    }
    .tag.ok{background:rgba(31,191,107,.14); border:1px solid rgba(31,191,107,.35)}
    .tag.warn{background:rgba(255,176,32,.14); border:1px solid rgba(255,176,32,.35)}
    .tag.bad{background:rgba(255,59,59,.14); border:1px solid rgba(255,59,59,.35)}

    .pickGrid{display:grid; grid-template-columns: 1fr 1fr; gap:14px}
    @media(max-width:900px){ .pickGrid{grid-template-columns:1fr} }
    .slot{
      border:1px dashed rgba(255,255,255,.25);
      background:rgba(0,0,0,.22);
      border-radius:16px;
      padding:12px;
      min-height:62px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .slot .num{
      width:40px;height:40px;border-radius:14px;
      display:grid;place-items:center;
      font-weight:900;
      background:rgba(216,35,42,.18);
      border:1px solid rgba(216,35,42,.28);
    }
    .slot .name{font-weight:850}
    .slot .empty{opacity:.55}
    .driverList{
      max-height:420px; overflow:auto;
      border:1px solid var(--border);
      border-radius:16px;
      background:rgba(0,0,0,.18);
    }
    .driver{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .driver:last-child{border-bottom:none}
    .driver .left{display:flex; flex-direction:column; line-height:1.15}
    .driver .left b{font-size:14px}
    .driver .left span{font-size:12px; opacity:.7}
    .dragHint{opacity:.7; font-weight:800; font-size:12px}
    .okline{
      margin-top:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(31,191,107,.35);
      background:rgba(31,191,107,.12);
      display:flex; gap:10px; align-items:center;
      font-weight:800;
    }
    .hide{display:none!important}
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    label{font-size:12px; opacity:.8; font-weight:800}
    table{width:100%; border-collapse:collapse}
    th, td{padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.10); text-align:left; font-size:14px}
    th{opacity:.85}
    .right{text-align:right}
  </style>
</head>
<body>

  <div class="topbar">
    <div class="brand">
      <div class="pill">F1</div>
      <div>2026 TIPP LIGA</div>
    </div>
    <div class="nav" id="nav">
      <a href="#home" data-route="home">Kezd≈ë</a>
      <a href="#races" data-route="races">Versenynapt√°r</a>
      <a href="#standings" data-route="standings">Ranglista</a>
      <a href="#login" data-route="login">Bel√©p√©s</a>
      <a href="#admin" data-route="admin" id="nav-admin" class="hide">Admin</a>
    </div>
  </div>

  <div class="wrap">
    <section class="card" id="page-home">
      <div class="card-h">
        <div class="tag">MVP ‚Ä¢ Futamlista ‚Üí Tipp oldal + ‚úÖ jel√∂l√©s + Pontoz√°s + Admin</div>
        <h2 style="margin-top:12px;font-size:44px;letter-spacing:.3px">F1 2026 Tipp Liga</h2>
        <div class="muted" style="max-width:760px">
          Tippelj futamonk√©nt 1‚Äì5 helyre. A versenynapt√°r jelzi, ha m√°r mentett√©l.
          Admin oldalon r√∂gz√≠ted a val√≥s top5-√∂t ‚Üí Ranglista pontoz.
        </div>
      </div>
      <div class="card-b">
        <div class="row">
          <button class="btn" id="go-races">üóìÔ∏è Versenynapt√°r</button>
          <button class="btn secondary" id="go-login">üîê Bel√©p√©s</button>
          <button class="btn secondary" id="btn-refresh">üîÑ Friss√≠t√©s</button>
        </div>

        <div class="status" id="status">
          <span class="dot warn" id="status-dot"></span>
          <span id="status-text">St√°tusz: ellen≈ërz√©s...</span>
        </div>
      </div>
    </section>

    <section class="card hide" id="page-races" style="margin-top:16px">
      <div class="card-h">
        <h2>üóìÔ∏è Versenynapt√°r</h2>
        <div class="muted">‚úÖ jel√∂li, ha m√°r van mentett tipped.</div>
      </div>
      <div class="card-b">
        <div class="row">
          <button class="btn secondary small" id="races-back">‚¨ÖÔ∏è Vissza</button>
          <button class="btn small" id="races-refresh">üîÑ Lista friss√≠t√©se</button>
        </div>
        <div class="status" style="margin-top:14px">
          <span class="dot warn"></span>
          <span id="races-status">Futamok bet√∂lt√©se...</span>
        </div>
        <div class="list" id="races-list" style="margin-top:14px"></div>
      </div>
    </section>

    <section class="card hide" id="page-pick" style="margin-top:16px">
      <div class="card-h">
        <h2 id="pick-title">üèÅ Tipp oldal</h2>
        <div class="muted" id="pick-sub">Futam adatok bet√∂lt√©se...</div>
      </div>
      <div class="card-b">
        <div class="row">
          <button class="btn secondary small" id="pick-back">‚¨ÖÔ∏è Vissza a futamokhoz</button>
          <button class="btn secondary small" id="pick-clear">üßπ T√∂rl√©s</button>
          <button class="btn secondary small" id="pick-remove">üóëÔ∏è Tipp t√∂rl√©se</button>
          <button class="btn small" id="pick-save">üíæ Tipp ment√©se</button>
        </div>

        <div class="pickGrid" style="margin-top:14px">
          <div class="col">
            <div class="tag" style="display:inline-block;margin-bottom:10px">Helyez√©sek (1‚Äì5)</div>
            <div id="slots"></div>
            <div class="okline hide" id="pick-loaded">‚úÖ Kor√°bbi tipped bet√∂ltve.</div>
          </div>
          <div class="col">
            <div class="tag" style="display:inline-block;margin-bottom:10px">Pil√≥t√°k</div>
            <div class="muted" style="margin-bottom:10px">H√∫zd a pil√≥t√°t egy helyre.</div>
            <div class="driverList" id="drivers"></div>
          </div>
        </div>

        <div class="status" style="margin-top:14px">
          <span class="dot warn"></span>
          <span id="pick-status">Bet√∂lt√©s...</span>
        </div>
      </div>
    </section>

    <section class="card hide" id="page-login" style="margin-top:16px">
      <div class="card-h">
        <h2>üîê Bel√©p√©s</h2>
        <div class="muted">Email + jelsz√≥ (Supabase Auth).</div>
      </div>
      <div class="card-b">
        <div class="row">
          <div class="col">
            <label>Email</label>
            <input id="login-email" placeholder="email@valami.com" />
          </div>
          <div class="col">
            <label>Jelsz√≥</label>
            <input id="login-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          </div>
        </div>
        <div class="row" style="margin-top:14px">
          <button class="btn" id="btn-signin">Bel√©p√©s</button>
          <button class="btn secondary" id="btn-signup">Regisztr√°ci√≥</button>
          <button class="btn secondary" id="btn-signout">Kijelentkez√©s</button>
          <button class="btn secondary" id="login-back">Vissza</button>
        </div>

        <div class="status">
          <span class="dot warn" id="login-dot"></span>
          <span id="login-status">√Ållapot: ellen≈ërz√©s...</span>
        </div>
      </div>
    </section>

    <section class="card hide" id="page-standings" style="margin-top:16px">
      <div class="card-h">
        <h2>üèÜ Ranglista</h2>
        <div class="muted">
          Pontoz√°s: +3 pont ha helyes poz√≠ci√≥, +1 pont ha benne van a top5-ben, de rossz helyen.
          (Admin r√∂gz√≠ti a val√≥s top5-√∂t.)
        </div>
      </div>
      <div class="card-b">
        <div class="row">
          <button class="btn small" id="standings-refresh">üîÑ Ranglista friss√≠t√©se</button>
        </div>

        <div class="status">
          <span class="dot warn"></span>
          <span id="standings-status">Bet√∂lt√©s...</span>
        </div>

        <div style="margin-top:14px; overflow:auto">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>J√°t√©kos</th>
                <th class="right">Pont</th>
                <th class="right">Futamok</th>
              </tr>
            </thead>
            <tbody id="standings-body"></tbody>
          </table>
        </div>

        <!-- ‚úÖ √öJ: Csapat ranglista -->
        <div style="margin-top:18px">
          <h3 style="margin:0 0 10px 0">üë• Csapat ranglista</h3>
          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Csapat</th>
                  <th class="right">Pont</th>
                </tr>
              </thead>
              <tbody id="team-standings-body"></tbody>
            </table>
          </div>
        </div>

      </div>
    </section>

    <section class="card hide" id="page-admin" style="margin-top:16px">
      <div class="card-h">
        <h2>üõ†Ô∏è Admin ‚Äì Val√≥s eredm√©ny r√∂gz√≠t√©se</h2>
        <div class="muted">Itt √°ll√≠tod be futamonk√©nt a val√≥s top5-√∂t. Csak admin emaillel l√°tszik.</div>
      </div>
      <div class="card-b">
        <div class="row">
          <div class="col">
            <label>Futam</label>
            <select id="admin-race"></select>
          </div>
          <div class="col">
            <label>St√°tusz</label>
            <div class="status" style="margin-top:6px">
              <span class="dot warn" id="admin-dot"></span>
              <span id="admin-status">Bet√∂lt√©s...</span>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:14px">
          <div class="col"><label>1. hely</label><select id="ar1"></select></div>
          <div class="col"><label>2. hely</label><select id="ar2"></select></div>
          <div class="col"><label>3. hely</label><select id="ar3"></select></div>
        </div>
        <div class="row" style="margin-top:14px">
          <div class="col"><label>4. hely</label><select id="ar4"></select></div>
          <div class="col"><label>5. hely</label><select id="ar5"></select></div>
          <div class="col" style="display:flex; align-items:end; gap:12px">
            <button class="btn" id="admin-save">üíæ Eredm√©ny ment√©se</button>
            <hr style="border:0;border-top:1px solid rgba(255,255,255,.10);margin:18px 0">

            <h3 style="margin:0 0 10px 0">üë• Csapat √∂ssze√°ll√≠t√°s (2 f≈ë / csapat)</h3>
            <div class="muted" style="margin-bottom:12px">
              Szab√°ly: 1 user csak 1 csapatban lehet. Ment√©skor automatikusan kivessz√ºk m√°shonnan.
            </div>

            <div class="row">
              <div class="col">
                <label>Csapat</label>
                <select id="admin-team"></select>
              </div>
              <div class="col">
                <label>St√°tusz</label>
                <div class="status" style="margin-top:6px">
                  <span class="dot warn" id="team-dot"></span>
                  <span id="team-status">Bet√∂lt√©s...</span>
                </div>
              </div>
            </div>

            <div class="row" style="margin-top:14px">
              <div class="col"><label>Tag #1</label><select id="tm1"></select></div>
              <div class="col"><label>Tag #2</label><select id="tm2"></select></div>
              <div class="col" style="display:flex; align-items:end; gap:12px">
                <button class="btn" id="team-save">üíæ Csapat ment√©se</button>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <div class="foot">¬© F1 Tipp Liga 2026 ‚Ä¢ GitHub Pages ‚Ä¢ Supabase</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <script>
    const SUPABASE_URL = "https://mtobtiwoiqqxdkduvjmf.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10b2J0aXdvaXFxeGRrZHV2am1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMTY2NzAsImV4cCI6MjA4MzY5MjY3MH0.qB5tb9uj2GN4iKRvyZnv_lVRZ9xnlgtY3rN6oZV_LDc";

    const ADMIN_EMAILS = ["zoltan.csombok@hellmann.com","zsuliett.csombok@gmail.com"];

    const sb = window.sb || (window.sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, storage: window.localStorage }
    }));

    const $ = (id)=>document.getElementById(id);
    const setActiveNav = (route)=>{
      document.querySelectorAll("#nav a").forEach(a=>{
        a.classList.toggle("active", a.dataset.route === route);
      });
    };
    const showPage = (route)=>{
      const pages = ["home","races","pick","login","standings","admin"];
      pages.forEach(p => $("page-"+p).classList.add("hide"));
      $("page-"+route).classList.remove("hide");
      setActiveNav(route);
    };
    const goto = (hash)=>{ location.hash = hash; };

    let currentUser = null;
    let racesCache = [];
    let driversCache = [];
    let currentRaceId = null;
    let pickSlots = [null,null,null,null,null];

    let myPickRaceIds = new Set();

    // ===== Tipp lez√°r√°s helper =====
    function isRaceLocked(race){
      if(!race || !race.start_at) return false;
      const now = new Date();
      const start = new Date(race.start_at);
      return now >= start;
    }

    function applyPickLockUI(race){
      const locked = isRaceLocked(race);
      if(locked){
        $("pick-status").textContent = "A tippel√©s lez√°rult ehhez a futamhoz.";
        $("pick-save").style.display = "none";
      } else {
        $("pick-save").style.display = "inline-flex";
      }
      return locked;
    }

    function setStatus(kind, text){
      const dot = $("status-dot");
      dot.classList.remove("ok","warn","bad");
      dot.classList.add(kind);
      $("status-text").textContent = text;
    }
    function setLoginStatus(kind, text){
      const dot = $("login-dot");
      dot.classList.remove("ok","warn","bad");
      dot.classList.add(kind);
      $("login-status").textContent = text;
    }
    function setAdminStatus(kind, text){
      const dot = $("admin-dot");
      dot.classList.remove("ok","warn","bad");
      dot.classList.add(kind);
      $("admin-status").textContent = text;
    }

    async function refreshAuth(){
      const { data, error } = await sb.auth.getUser();
      if(error){
        currentUser = null;
        setStatus("warn", "Auth hiba (nincs bel√©pve).");
        setLoginStatus("warn", "Nincs bel√©pve.");
      } else {
        currentUser = data?.user ?? null;
        if(currentUser){
          setStatus("ok", "Bejelentkezve: " + (currentUser.email || "felhaszn√°l√≥"));
          setLoginStatus("ok", "Bejelentkezve: " + (currentUser.email || "felhaszn√°l√≥"));
        }else{
          setStatus("warn", "Nincs bel√©pve. A ment√©shez bel√©p√©s kell.");
          setLoginStatus("warn", "Nincs bel√©pve.");
        }
      }

      const isAdmin = !!currentUser && ADMIN_EMAILS.includes(currentUser.email);
      $("nav-admin").classList.toggle("hide", !isAdmin);

      return currentUser;
    }

    sb.auth.onAuthStateChange(()=>{ refreshAuth(); });

    async function loadDrivers(){
      const { data, error } = await sb
        .from("drivers")
        .select("id, code, name, team")
        .order("name", { ascending: true });
      if(error) throw error;
      driversCache = data || [];
      return driversCache;
    }

    async function loadRaces(){
      const { data, error } = await sb
        .from("races")
        .select("id, round, name, location, start_date, end_date, start_at")
        .order("round", { ascending: true });
      if(error) throw error;
      racesCache = data || [];
      return racesCache;
    }

    function formatRange(r){
      if(!r.start_date) return "";
      const s = String(r.start_date).slice(0,10);
      const e = r.end_date ? String(r.end_date).slice(0,10) : "";
      return e ? `${s} ‚Üí ${e}` : s;
    }

    async function loadMyPickFlags(){
      myPickRaceIds = new Set();
      if(!currentUser) return myPickRaceIds;

      const { data, error } = await sb
        .from("picks")
        .select("race_id")
        .eq("user_id", currentUser.id);

      if(error) throw error;
      (data || []).forEach(x => myPickRaceIds.add(String(x.race_id)));
      return myPickRaceIds;
    }

    function renderRaces(){
      const list = $("races-list");
      list.innerHTML = "";
      racesCache.forEach(r=>{
        const el = document.createElement("div");
        el.className = "item";

        const hasPick = myPickRaceIds.has(String(r.id));
        const badge = hasPick
          ? `<span class="tag ok">‚úÖ Mentve</span>`
          : `<span class="tag warn">‚è≥ Nincs tipp</span>`;

        el.innerHTML = `
          <div>
            <b>Futam #${r.round || "?"} ‚Ä¢ ${r.name || "N√©v n√©lk√ºl"} ${badge}</b>
            <div class="muted" style="font-size:12px;margin-top:2px">${r.location || ""} ‚Ä¢ ${formatRange(r)}</div>
          </div>
          <button class="btn small">Tipp ‚ûú</button>
        `;
        el.querySelector("button").addEventListener("click", ()=>{
          goto(`#pick?race=${encodeURIComponent(r.id)}`);
        });
        list.appendChild(el);
      });

      $("races-status").textContent = racesCache.length
        ? `Bet√∂ltve: ${racesCache.length} futam`
        : "Nincs futam a t√°bl√°ban.";
    }

    function renderSlots(){
      const wrap = $("slots");
      wrap.innerHTML = "";
      for(let i=0;i<5;i++){
        const d = pickSlots[i];
        const el = document.createElement("div");
        el.className = "slot";
        el.dataset.index = String(i);
        el.innerHTML = `
          <div style="display:flex;align-items:center;gap:12px">
            <div class="num">#${i+1}</div>
            <div>
              <div class="name ${d ? "" : "empty"}">${d ? d.name : "H√∫zz ide egy pil√≥t√°t"}</div>
              <div class="muted" style="font-size:12px">${d ? (d.team || "") : ""}</div>
            </div>
          </div>
          <div class="dragHint">${d ? "H√∫zd √°t m√°shova" : ""}</div>
        `;
        el.addEventListener("dragover", (ev)=>{ ev.preventDefault(); });
        el.addEventListener("drop", (ev)=>{
          ev.preventDefault();
          const driverId = ev.dataTransfer.getData("text/driverId");
          if(!driverId) return;
          const drv = driversCache.find(x=>String(x.id)===String(driverId));
          if(!drv) return;
          placeDriver(i, drv);
        });
        wrap.appendChild(el);
      }
    }

    function renderDrivers(){
      const wrap = $("drivers");
      wrap.innerHTML = "";
      driversCache.forEach(d=>{
        const el = document.createElement("div");
        el.className = "driver";
        el.draggable = true;
        el.innerHTML = `
          <div class="left">
            <b>${d.name}</b>
            <span>${d.team || ""}</span>
          </div>
          <div class="dragHint">H√∫zd ‚Üí</div>
        `;
        el.addEventListener("dragstart",(ev)=>{
          ev.dataTransfer.setData("text/driverId", String(d.id));
        });
        wrap.appendChild(el);
      });
    }

    function placeDriver(slotIndex, driver){
      pickSlots = pickSlots.map(x => (x && x.id === driver.id) ? null : x);
      pickSlots[slotIndex] = driver;
      renderSlots();
    }

    function clearPick(){
      pickSlots = [null,null,null,null,null];
      $("pick-loaded").classList.add("hide");
      renderSlots();
    }

    async function loadExistingPick(raceId){
      $("pick-loaded").classList.add("hide");
      if(!currentUser) return;

      const { data, error } = await sb
        .from("picks")
        .select("p1,p2,p3,p4,p5")
        .eq("user_id", currentUser.id)
        .eq("race_id", raceId)
        .maybeSingle();

      if(error) throw error;

      if(data){
        const ids = [data.p1, data.p2, data.p3, data.p4, data.p5];
        const resolved = ids.map(id=>{
          if(!id) return null;
          return driversCache.find(d=>String(d.id)===String(id)) || null;
        });
        pickSlots = [resolved[0],resolved[1],resolved[2],resolved[3],resolved[4]];
        renderSlots();

        const any = pickSlots.some(x=>x!==null);
        if(any) $("pick-loaded").classList.remove("hide");
      }
    }

    async function savePick(){
      if(!currentUser){
        $("pick-status").textContent = "Ment√©shez bel√©p√©s kell.";
        goto("#login");
        return;
      }
      if(!currentRaceId){
        $("pick-status").textContent = "Nincs kiv√°lasztott futam.";
        return;
      }

      // ‚úÖ Tipp lez√°r√°s ellen≈ërz√©s
      const race = racesCache.find(r => String(r.id) === String(currentRaceId));
      if(race && isRaceLocked(race)){
        $("pick-status").textContent = "A tippel√©s lez√°rult ehhez a futamhoz.";
        $("pick-save").style.display = "none";
        return;
      }

      const allFilled = pickSlots.every(d => d && d.id);
      if(!allFilled){
        $("pick-status").textContent = "A ment√©shez t√∂ltsd ki mind az 5 helyet (1‚Äì5).";
        return;
      }

      $("pick-status").textContent = "Ment√©s...";
      const payload = {
        user_id: currentUser.id,
        race_id: currentRaceId,
        p1: String(pickSlots[0].id),
        p2: String(pickSlots[1].id),
        p3: String(pickSlots[2].id),
        p4: String(pickSlots[3].id),
        p5: String(pickSlots[4].id)
      };

      const { error } = await sb
        .from("picks")
        .upsert(payload, { onConflict: "user_id,race_id" });

      if(error){
        console.error(error);
        $("pick-status").textContent = "Hiba ment√©skor: " + error.message;
        return;
      }

      myPickRaceIds.add(String(currentRaceId));
      $("pick-status").textContent = "Sikeres ment√©s ‚úÖ";
    }

    async function deletePick(){
      if(!currentUser || !currentRaceId) return;
      $("pick-status").textContent = "Tipp t√∂rl√©se...";
      const { error } = await sb
        .from("picks")
        .delete()
        .eq("user_id", currentUser.id)
        .eq("race_id", currentRaceId);

      if(error){
        console.error(error);
        $("pick-status").textContent = "Hiba t√∂rl√©skor: " + error.message;
        return;
      }
      myPickRaceIds.delete(String(currentRaceId));
      clearPick();
      $("pick-status").textContent = "Tipp t√∂r√∂lve ‚úÖ";
    }

    function scorePick(pickIds, resultIds){
      let pts = 0;
      const res = resultIds.map(x => String(x));
      for(let i=0;i<5;i++){
        const pid = pickIds[i] ? String(pickIds[i]) : "";
        if(!pid) continue;
        if(res[i] && pid === res[i]) pts += 3;
        else if(res.includes(pid)) pts += 1;
      }
      return pts;
    }

    async function loadStandings(){
      if(!currentUser){
        $("standings-status").textContent = "Ranglist√°hoz k√©rlek l√©pj be.";
        $("standings-body").innerHTML = "";
        const tb = $("team-standings-body");
        if(tb) tb.innerHTML = "";
        return;
      }

      $("standings-status").textContent = "Bet√∂lt√©s...";
      $("standings-body").innerHTML = "";
      const teamBody = $("team-standings-body");
      if(teamBody) teamBody.innerHTML = "";

      const profileMap = new Map();
      try{
        const pr = await sb.from("profiles").select("user_id,email,display_name");
        if(!pr.error){
          (pr.data || []).forEach(p=>{
            profileMap.set(String(p.user_id), {
              display_name: p.display_name || "",
              email: p.email || ""
            });
          });
        }
      }catch(e){}

      const rr = await sb
        .from("race_results")
        .select("race_id, position, driver_id")
        .order("race_id", { ascending: true })
        .order("position", { ascending: true });

      if(rr.error){
        $("standings-status").textContent = "Hiba: race_results nem olvashat√≥: " + rr.error.message;
        return;
      }

      const tmp = new Map();
      (rr.data || []).forEach(row=>{
        const rid = String(row.race_id);
        const pos = Number(row.position);
        const did = row.driver_id ? String(row.driver_id) : null;
        if(!tmp.has(rid)) tmp.set(rid, [null,null,null,null,null]);
        if(pos >= 1 && pos <= 5) tmp.get(rid)[pos-1] = did;
      });

      const resultsMap = new Map();
      for(const [rid, arr] of tmp.entries()){
        if(arr.every(x => !!x)) resultsMap.set(rid, arr);
      }

      const pk = await sb.from("picks").select("user_id,race_id,p1,p2,p3,p4,p5");
      if(pk.error){
        $("standings-status").textContent = "Hiba: picks nem olvashat√≥: " + pk.error.message;
        return;
      }

      const byUser = new Map();
      (pk.data||[]).forEach(p=>{
        const raceId = String(p.race_id);
        const res = resultsMap.get(raceId);
        if(!res) return;

        const pickIds = [p.p1,p.p2,p.p3,p.p4,p.p5].map(x => x ? String(x) : "");
        const pts = scorePick(pickIds, res);

        const uid = String(p.user_id);
        if(!byUser.has(uid)) byUser.set(uid, { user_id: uid, points: 0, races: 0 });
        const u = byUser.get(uid);
        u.points += pts;
        u.races += 1;
      });

      const arr = Array.from(byUser.values()).sort((a,b)=>b.points-a.points);

      if(resultsMap.size === 0){
        $("standings-status").textContent = "M√©g nincs pontozhat√≥ futam (Admin oldalon mentsd el a top5-√∂t).";
        return;
      }

      if(arr.length === 0){
        $("standings-status").textContent = "Van eredm√©ny, de m√©g nincs tipp azon a futamon.";
        return;
      }

      arr.forEach((u, idx)=>{
        const tr = document.createElement("tr");

        const p = profileMap.get(String(u.user_id)) || {};
        const name = (p.display_name || p.email || u.user_id);

        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${name}</td>
          <td class="right"><b>${u.points}</b></td>
          <td class="right">${u.races}</td>
        `;
        $("standings-body").appendChild(tr);
      });

      try{
        if(teamBody){
          const tm = await sb.from("team_members").select("team_id,user_id");
          const ts = await sb.from("teams").select("id,name");

          if(!tm.error && !ts.error){
            const teamName = new Map((ts.data||[]).map(t=>[String(t.id), t.name]));
            const userTeam = new Map();
            (tm.data||[]).forEach(r=> userTeam.set(String(r.user_id), String(r.team_id)));

            const teamPoints = new Map();
            arr.forEach(u=>{
              const tid = userTeam.get(String(u.user_id));
              if(!tid) return;
              teamPoints.set(tid, (teamPoints.get(tid)||0) + (u.points||0));
            });

            const teamArr = Array.from(teamPoints.entries())
              .map(([team_id, points])=>({ team_id, points, name: teamName.get(team_id) || team_id }))
              .sort((a,b)=>b.points-a.points);

            teamArr.forEach((t, idx)=>{
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${idx+1}</td>
                <td><b>${t.name}</b></td>
                <td class="right"><b>${t.points}</b></td>
              `;
              teamBody.appendChild(tr);
            });
          }
        }
      }catch(e){}

      $("standings-status").textContent = `K√©sz. Pontozhat√≥ futamok: ${resultsMap.size}`;
    }

    function fillDriverSelect(selId){
      const sel = $(selId);
      sel.innerHTML = "";
      driversCache.forEach(d=>{
        const opt = document.createElement("option");
        opt.value = String(d.id);
        opt.textContent = `${d.name} (${d.team || ""})`;
        sel.appendChild(opt);
      });
    }

    function fillRaceSelect(){
      const sel = $("admin-race");
      sel.innerHTML = "";
      racesCache.forEach(r=>{
        const opt = document.createElement("option");
        opt.value = String(r.id);
        opt.textContent = `#${r.round || "?"} ‚Ä¢ ${r.name || ""} ‚Ä¢ ${r.location || ""}`;
        sel.appendChild(opt);
      });
    }

    async function loadAdminExisting(raceId){
      setAdminStatus("warn","Eredm√©ny ellen≈ërz√©se...");

      const { data, error } = await sb
        .from("race_results")
        .select("position, driver_id")
        .eq("race_id", raceId)
        .order("position", { ascending: true });

      if(error){
        setAdminStatus("bad","Hiba: " + error.message);
        return;
      }

      if(data && data.length){
        const arr = [null,null,null,null,null];
        data.forEach(r=>{
          const pos = Number(r.position);
          if(pos>=1 && pos<=5) arr[pos-1] = String(r.driver_id);
        });

        if(arr.every(Boolean)){
          $("ar1").value = arr[0];
          $("ar2").value = arr[1];
          $("ar3").value = arr[2];
          $("ar4").value = arr[3];
          $("ar5").value = arr[4];
          setAdminStatus("ok","Van m√°r mentett eredm√©ny ehhez a futamhoz.");
        } else {
          setAdminStatus("warn","Van r√©szleges eredm√©ny. √Åll√≠tsd be mind az 5 helyet √©s mentsd el.");
        }
      }else{
        setAdminStatus("warn","Nincs m√©g mentett eredm√©ny, √°ll√≠tsd be a top5-√∂t.");
      }
    }

    async function saveRaceResult(){
      if(!currentUser || !ADMIN_EMAILS.includes(currentUser.email)){
        setAdminStatus("bad","Nincs admin jogosults√°g.");
        return;
      }
      const raceId = $("admin-race").value;

      const d1 = $("ar1").value, d2 = $("ar2").value, d3 = $("ar3").value, d4 = $("ar4").value, d5 = $("ar5").value;
      const uniq = new Set([d1,d2,d3,d4,d5]);
      if(uniq.size < 5){
        setAdminStatus("bad","Ugyanaz a pil√≥ta t√∂bbsz√∂r szerepel. Mind az 5 legyen k√ºl√∂nb√∂z≈ë.");
        return;
      }

      setAdminStatus("warn","Ment√©s...");

      const del = await sb.from("race_results").delete().eq("race_id", raceId);
      if(del.error){
        setAdminStatus("bad","Hiba t√∂rl√©skor: " + del.error.message);
        return;
      }

      const rows = [
        { race_id: raceId, position: 1, driver_id: d1 },
        { race_id: raceId, position: 2, driver_id: d2 },
        { race_id: raceId, position: 3, driver_id: d3 },
        { race_id: raceId, position: 4, driver_id: d4 },
        { race_id: raceId, position: 5, driver_id: d5 },
      ];

      const ins = await sb.from("race_results").insert(rows);
      if(ins.error){
        setAdminStatus("bad","Hiba ment√©skor: " + ins.error.message);
        return;
      }

      setAdminStatus("ok","Eredm√©ny mentve ‚úÖ (5 sor)");
    }

    function parseHash(){
      const h = (location.hash || "#home").slice(1);
      const [route, query] = h.split("?");
      const params = new URLSearchParams(query || "");
      return { route: route || "home", params };
    }

    async function onRoute(){
      const { route, params } = parseHash();

      if(route === "home"){ showPage("home"); return; }
      if(route === "login"){ showPage("login"); return; }

      if(route === "standings"){
        showPage("standings");
        await refreshAuth();
        await loadStandings();
        return;
      }

      if(route === "admin"){
        showPage("admin");
        await refreshAuth();

        if(!currentUser || !ADMIN_EMAILS.includes(currentUser.email)){
          setAdminStatus("bad","Nincs admin jogosults√°g ehhez az oldalhoz.");
          return;
        }

        try{
          if(!driversCache.length) await loadDrivers();
          if(!racesCache.length) await loadRaces();
          fillRaceSelect();
          ["ar1","ar2","ar3","ar4","ar5"].forEach(fillDriverSelect);

          const raceId = $("admin-race").value;
          await loadAdminExisting(raceId);

          $("admin-race").onchange = async ()=> loadAdminExisting($("admin-race").value);

          setAdminStatus("ok","Admin oldal k√©sz.");
        }catch(e){
          setAdminStatus("bad","Hiba: " + (e?.message || e));
        }
        return;
      }

      if(route === "races"){
        showPage("races");
        $("races-status").textContent = "Futamok bet√∂lt√©se...";
        try{
          await refreshAuth();
          await loadRaces();
          await loadMyPickFlags();
          renderRaces();
        }catch(e){
          console.error(e);
          $("races-status").textContent = "Hiba futam bet√∂lt√©sn√©l: " + (e?.message || e);
        }
        return;
      }

      if(route === "pick"){
        showPage("pick");
        const raceId = params.get("race");
        currentRaceId = raceId;

        if(!raceId){
          $("pick-title").textContent = "üèÅ Tipp oldal";
          $("pick-sub").textContent = "Nincs race param√©ter. Menj vissza a versenynapt√°rba.";
          $("pick-status").textContent = "Nincs futam.";
          return;
        }

        $("pick-status").textContent = "Bet√∂lt√©s...";
        try{
          if(!driversCache.length) await loadDrivers();
          renderDrivers();
          renderSlots();

          if(!racesCache.length) { try { await loadRaces(); } catch {} }
          const r2 = racesCache.find(r=>String(r.id)===String(raceId));

          $("pick-title").textContent = `üèÅ Tipp oldal (drag & drop)`;
          $("pick-sub").textContent = r2
            ? `Futam: #${r2.round || "?"} ‚Ä¢ ${r2.name || ""} ‚Ä¢ ${r2.location || ""} ‚Ä¢ ${formatRange(r2)}`
            : `Race ID: ${raceId}`;

          clearPick();
          await refreshAuth();
          await loadExistingPick(raceId);

          // ‚úÖ UI lez√°r√°s be√°ll√≠t√°sa a rajtid≈ë alapj√°n
          applyPickLockUI(r2);

          if(!isRaceLocked(r2)){
            $("pick-status").textContent = "K√©sz.";
          }
        }catch(e){
          console.error(e);
          $("pick-status").textContent = "Hiba: " + (e?.message || e);
        }
        return;
      }

      showPage("home");
    }

    $("go-races").addEventListener("click", ()=>goto("#races"));
    $("go-login").addEventListener("click", ()=>goto("#login"));
    $("btn-refresh").addEventListener("click", async ()=>{
      await refreshAuth();
      setStatus(currentUser ? "ok" : "warn", currentUser ? "Friss√≠tve ‚úÖ" : "Friss√≠tve: nincs bel√©pve.");
    });

    $("races-back").addEventListener("click", ()=>goto("#home"));
    $("races-refresh").addEventListener("click", async ()=>{
      $("races-status").textContent = "Friss√≠t√©s...";
      try{
        await refreshAuth();
        await loadRaces();
        await loadMyPickFlags();
        renderRaces();
      }catch(e){
        console.error(e);
        $("races-status").textContent = "Hiba: " + (e?.message || e);
      }
    });

    $("pick-back").addEventListener("click", ()=>goto("#races"));
    $("pick-clear").addEventListener("click", ()=>{ clearPick(); $("pick-status").textContent="√úr√≠tve."; });
    $("pick-save").addEventListener("click", savePick);
    $("pick-remove").addEventListener("click", deletePick);

    $("login-back").addEventListener("click", ()=>goto("#home"));

    $("btn-signin").addEventListener("click", async ()=>{
      const email = $("login-email").value.trim();
      const password = $("login-pass").value;
      if(!email || !password){ setLoginStatus("warn","Hi√°nyzik email vagy jelsz√≥."); return; }
      setLoginStatus("warn","Bel√©p√©s...");
      const { error } = await sb.auth.signInWithPassword({ email, password });
      if(error){ setLoginStatus("bad","Hiba: " + error.message); return; }
      setLoginStatus("ok","Sikeres bel√©p√©s ‚úÖ");
      goto("#home");
    });

    $("btn-signup").addEventListener("click", async ()=>{
      const email = $("login-email").value.trim();
      const password = $("login-pass").value;
      if(!email || !password){ setLoginStatus("warn","Hi√°nyzik email vagy jelsz√≥."); return; }
      setLoginStatus("warn","Regisztr√°ci√≥...");
      const { error } = await sb.auth.signUp({ email, password });
      if(error){ setLoginStatus("bad","Hiba: " + error.message); return; }
      setLoginStatus("ok","Regisztr√°ci√≥ ok ‚úÖ");
      goto("#home");
    });

    $("btn-signout").addEventListener("click", async ()=>{
      setLoginStatus("warn","Kijelentkez√©s...");
      const { error } = await sb.auth.signOut();
      if(error){ setLoginStatus("bad","Hiba: " + error.message); return; }
      setLoginStatus("ok","Kijelentkezve ‚úÖ");
      goto("#home");
    });

    $("standings-refresh").addEventListener("click", loadStandings);
    $("admin-save").addEventListener("click", saveRaceResult);

    window.addEventListener("hashchange", onRoute);

    (async function init(){
      try{
        await refreshAuth();
        try{ await loadDrivers(); }catch(e){ console.warn("drivers load failed", e); }
        try{ await loadRaces(); }catch(e){ console.warn("races load failed", e); }
        onRoute();
      }catch(e){
        console.error(e);
        setStatus("bad", "Inicializ√°l√°si hiba: " + (e?.message || e));
      }
    })();
  </script>
</body>
</html>
