<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>F1 2026 Tipp Liga</title>
  <link rel="icon" href="data:,">
  <style>
    :root{
      --red:#c40000;
      --red2:#ff2a2a;
      --bg:#050505;
      --panel:#101010;
      --text:#f2f2f2;
      --muted:#bdbdbd;
      --line:#2a2a2a;
      --glow: rgba(255, 0, 0, .22);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:
        radial-gradient(1200px 600px at 25% 15%, rgba(255,0,0,.18), transparent 55%),
        radial-gradient(900px 500px at 70% 30%, rgba(255,0,0,.12), transparent 55%),
        linear-gradient(#000,#050505 25%, #050505);
      color:var(--text);
    }
    .topbar{
      position:sticky; top:0; z-index:10;
      background: linear-gradient(90deg, #7f0000, var(--red));
      border-bottom:1px solid rgba(255,255,255,.06);
      padding:12px 18px;
    }
    .topbar-inner{
      max-width:1200px; margin:0 auto;
      display:flex; align-items:center; gap:14px;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.4px;}
    .brand-pill{
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
      padding:6px 10px;
      border-radius:999px;
      font-size:14px;
    }
    .nav{margin-left:auto; display:flex; gap:10px; flex-wrap:wrap;}
    .nav a{
      text-decoration:none; color:#fff;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 14px;
      border-radius:14px;
      font-weight:800;
    }
    .nav a:hover{ outline:2px solid rgba(255,255,255,.08); }

    .wrap{max-width:1200px; margin:22px auto 60px; padding:0 18px;}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.08);
      border-radius:22px;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      padding:22px;
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(500px 200px at 15% 15%, rgba(255,0,0,.18), transparent 60%);
      pointer-events:none;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
      color:var(--muted);
      font-weight:800;
      margin-bottom:10px;
      position:relative; z-index:1;
    }
    h1{margin:0 0 8px; font-size:44px; line-height:1.05; position:relative; z-index:1;}
    h2{margin:0 0 8px; position:relative; z-index:1;}
    p{position:relative; z-index:1;}
    .lead{margin:0 0 18px; color:#d7d7d7;}
    .muted{color:var(--muted);}
    .actions{display:flex; gap:10px; flex-wrap:wrap; position:relative; z-index:1;}
    .btn{
      cursor:pointer;
      border:none;
      border-radius:14px;
      padding:12px 16px;
      font-weight:900;
      color:#fff;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 12px 28px rgba(0,0,0,.35);
    }
    .btn.primary{
      background: linear-gradient(180deg, var(--red2), #b00000);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 18px 40px var(--glow);
    }
    .btn:hover{ outline:2px solid rgba(255,255,255,.08); }
    .hidden{display:none !important;}
    .line{
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      color:#e8e8e8;
      position:relative; z-index:1;
      word-break: break-word;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
      position:relative; z-index:1;
    }
    @media (max-width: 960px){
      .grid{grid-template-columns: 1fr;}
    }
    .list{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      position:relative; z-index:1;
    }
    .item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      border-radius:14px;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      cursor:pointer;
    }
    .item:hover{ outline:2px solid rgba(255,255,255,.08); }
    .item .title{font-weight:900}
    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:#fff;
      white-space:nowrap;
    }

    .drivers{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
    }
    .driver{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      cursor:grab;
      user-select:none;
    }
    .driver:active{cursor:grabbing}
    .avatar{
      width:28px; height:28px; border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      display:flex; align-items:center; justify-content:center;
      font-size:12px;
      font-weight:900;
    }
    .avatar img{width:100%; height:100%; object-fit:cover; display:block}
    .slots{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }
    .slot{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-radius:14px;
      background:rgba(0,0,0,.22);
      border:1px dashed rgba(255,255,255,.18);
      min-height:54px;
    }
    .slot strong{opacity:.9}
    .slot .dropHint{color:#dcdcdc; font-weight:800; opacity:.9}
    .slot.filled{
      border-style:solid;
      border-color: rgba(255,255,255,.12);
    }
    .foot{margin-top:18px; text-align:center; color:#bdbdbd; opacity:.9; font-size:14px;}
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <span class="brand-pill">F1</span>
        <span>2026 TIPP LIGA</span>
      </div>

      <nav class="nav">
        <a href="#home">Kezd≈ë</a>
        <a href="#races">Versenyek</a>
        <a href="#leaderboard">Ranglista</a>
        <a href="#login">Bel√©p√©s</a>
      </nav>
    </div>
  </header>

  <main class="wrap">

    <!-- HOME -->
    <section id="view-home">
      <div class="card">
        <div class="badge">üèÅ MVP ‚Ä¢ Futam kiv√°laszt√°s ‚Üí Tipp oldal (drag & drop)</div>
        <h1>F1 2026 Tipp Liga</h1>
        <p class="lead">F≈ëoldalon futamnapt√°r. Futamot kiv√°lasztva egy k√ºl√∂n oldalon h√∫zod be az 1‚Äì5. helyre a pil√≥t√°kat. Ment√©s Supabase-be.</p>

        <div class="actions">
          <button class="btn primary" onclick="goto('#races')">üìÖ Versenynapt√°r</button>
          <button class="btn" onclick="goto('#login')">üöÄ Bel√©p√©s</button>
          <button class="btn" onclick="hardRefresh()">üîÑ Friss√≠t√©s</button>
        </div>

        <div class="line" id="home-auth-line">üîí St√°tusz: <span class="muted">nincs ellen≈ërizve</span></div>
      </div>

      <div class="foot">¬© F1 Tipp Liga 2026 ‚Ä¢ GitHub Pages ‚Ä¢ Supabase</div>
    </section>

    <!-- RACES LIST -->
    <section id="view-races" class="hidden">
      <div class="card">
        <h2>üìÖ Versenynapt√°r</h2>
        <p class="muted">Kattints egy futamra ‚Üí √°tvissz a tipp oldalra.</p>

        <div id="races-list" class="list muted">Bet√∂lt√©s...</div>

        <div class="actions" style="margin-top:16px;">
          <button class="btn" onclick="goto('#home')">‚¨ÖÔ∏è Vissza</button>
          <button class="btn" onclick="loadRaces()">üîÑ Lista friss√≠t√©se</button>
        </div>

        <div id="races-output" class="line muted">K√©szen √°ll.</div>
      </div>
    </section>

    <!-- RACE DETAIL (TIP) -->
    <section id="view-race" class="hidden">
      <div class="card">
        <h2 id="race-title">üèÅ Futam</h2>
        <p class="muted">Bal oldalt pil√≥t√°k, jobb oldalt h√∫zd be az 1‚Äì5 helyre. Ment√©s ut√°n √∫jrat√∂lt√©skor is vissza kell j√∂nnie.</p>

        <div class="grid">
          <div>
            <h3 style="margin:10px 0 0; position:relative; z-index:1;">Pil√≥t√°k</h3>
            <div id="drivers-list" class="drivers muted">Bet√∂lt√©s...</div>
          </div>

          <div>
            <h3 style="margin:10px 0 0; position:relative; z-index:1;">Top5 tipped</h3>
            <div class="slots" id="slots">
              <!-- JS t√∂lti -->
            </div>

            <div class="actions" style="margin-top:12px;">
              <button class="btn" onclick="clearSlots()">üßπ T√∂rl√©s</button>
              <button class="btn primary" onclick="savePick()">üíæ Tipp ment√©se</button>
              <button class="btn" onclick="goto('#races')">‚¨ÖÔ∏è Vissza a futamokhoz</button>
            </div>

            <div id="race-output" class="line muted">K√©szen √°ll.</div>

            <div id="admin-panel" class="hidden">
              <div class="line">
                <b>üîß Admin panel</b><br>
                Itt k√©s≈ëbb be tudod √≠rni a val√≥di Top5 eredm√©nyt (k√ºl√∂n t√°bl√°ba), √©s a pontoz√°s is erre √©p√ºl.
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- LEADERBOARD -->
    <section id="view-leaderboard" class="hidden">
      <div class="card">
        <h2>üìä Ranglista</h2>
        <div class="muted">MVP: a pontsz√°m√≠t√°s + admin eredm√©nyek k√∂vetkez≈ë k√∂r. Most m√©g csak a tippek ment√©se m≈±k√∂dik.</div>
        <div class="actions" style="margin-top:16px;">
          <button class="btn" onclick="goto('#home')">‚¨ÖÔ∏è Vissza</button>
        </div>
      </div>
    </section>

    <!-- LOGIN -->
    <section id="view-login" class="hidden">
      <div class="card">
        <h2>üöÄ Bel√©p√©s</h2>
        <p class="muted">GitHub OAuth + Supabase session localStorage-ben.</p>

        <div class="actions">
          <button class="btn primary" onclick="testSupabase()">‚úÖ Supabase kapcsolat teszt</button>
          <button class="btn" onclick="loginWithGithub()">üêô GitHub bel√©p√©s</button>
          <button class="btn" onclick="logout()">üö™ Kijelentkez√©s</button>
          <button class="btn" onclick="hardRefresh()">üîÑ Friss√≠t√©s</button>
          <button class="btn" onclick="goto('#home')">‚¨ÖÔ∏è Vissza</button>
        </div>

        <div id="login-output" class="line muted">K√©szen √°ll.</div>
      </div>
    </section>

    <div class="foot">¬© F1 Tipp Liga 2026 ‚Ä¢ GitHub Pages ‚Ä¢ Supabase</div>
  </main>

  <!-- ===================== SUPABASE + AUTH ===================== -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // === SUPABASE CONFIG (N√ÅLAD EZ J√ì) ===
    const SUPABASE_URL = "https://mtobtiwoiqqxdkduvjmf.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10b2J0aXdvaXFxeGRrZHV2am1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMTY2NzAsImV4cCI6MjA4MzY5MjY3MH0.qB5tb9uj2GN4iKRvyZnv_lVRZ9xnlgtY3rN6oZV_LDc";

    const supabaseClient = window.supabase.createClient(
      SUPABASE_URL,
      SUPABASE_ANON_KEY,
      {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          storage: window.localStorage
        }
      }
    );

    // === ADMIN: IDE TEDD MAJD A SAJ√ÅT USER_ID-DAT (a login oldal ki√≠rja) ===
    const ADMIN_USER_IDS = [
      // "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
    ];

    // === ROUTING ===
    function goto(hash){ location.hash = hash; }
    function hardRefresh(){ location.reload(); }

    function showView(name){
      const views = ["home","races","race","leaderboard","login"];
      for (const v of views){
        const el = document.getElementById("view-" + v);
        if (el) el.classList.toggle("hidden", v !== name);
      }
    }

    function parseHash(){
      // t√°mogatott:
      // #home
      // #races
      // #race=<uuid>
      // #leaderboard
      // #login
      const raw = location.hash || "#home";
      if (raw.startsWith("#race=")){
        return { view:"race", raceId: raw.substring("#race=".length) };
      }
      const h = raw.replace("#","");
      const valid = new Set(["home","races","leaderboard","login"]);
      return { view: valid.has(h) ? h : "home" };
    }

    window.addEventListener("hashchange", route);
    route();

    async function route(){
      const r = parseHash();
      showView(r.view);

      await refreshHomeAuthLine();

      if (r.view === "races"){
        await loadRaces();
      }
      if (r.view === "race"){
        await openRace(r.raceId);
      }
    }

    // === AUTH UI ===
    supabaseClient.auth.onAuthStateChange(async (event, session) => {
      const out = document.getElementById("login-output");
      if (event === "SIGNED_IN" && session?.user){
        const name = session.user.user_metadata?.user_name || session.user.email || session.user.id;
        if (out) out.innerHTML = "‚úÖ Bejelentkezve: <b>" + escapeHtml(name) + "</b><br><span class='muted'>user_id: " + session.user.id + "</span>";
        await refreshHomeAuthLine();
      }
      if (event === "SIGNED_OUT"){
        if (out) out.textContent = "‚ÑπÔ∏è Kijelentkezve";
        await refreshHomeAuthLine();
      }
    });

    (async () => {
      const { data } = await supabaseClient.auth.getSession();
      const session = data?.session;
      const out = document.getElementById("login-output");
      if (out && session?.user){
        const name = session.user.user_metadata?.user_name || session.user.email || session.user.id;
        out.innerHTML = "‚úÖ M√°r be vagy l√©pve: <b>" + escapeHtml(name) + "</b><br><span class='muted'>user_id: " + session.user.id + "</span>";
      }
      await refreshHomeAuthLine();
    })();

    async function refreshHomeAuthLine(){
      const el = document.getElementById("home-auth-line");
      if (!el) return;

      const { data } = await supabaseClient.auth.getSession();
      const session = data?.session;

      if (session?.user){
        const name = session.user.user_metadata?.user_name || session.user.email || session.user.id;
        el.innerHTML = "üîì St√°tusz: <b>bejelentkezve</b> ‚Äì " + escapeHtml(name);
      } else {
        el.innerHTML = "üîí St√°tusz: <span class='muted'>nincs bejelentkezve</span>";
      }
    }

    async function loginWithGithub(){
      const out = document.getElementById("login-output");
      if (out) out.textContent = "‚è≥ GitHub bel√©p√©s ind√≠t√°sa...";

      // GitHub Pages redirect: fix, stabil
      const redirectTo = "https://zsuliettcsombok-bot.github.io/f1-tippliga/#login";

      const { error } = await supabaseClient.auth.signInWithOAuth({
        provider: "github",
        options: { redirectTo }
      });

      if (error && out) out.textContent = "‚ùå GitHub login hiba: " + error.message;
    }

    async function logout(){
      const out = document.getElementById("login-output");
      if (out) out.textContent = "‚è≥ Kijelentkez√©s...";
      const { error } = await supabaseClient.auth.signOut();
      if (error && out) out.textContent = "‚ùå Kijelentkez√©s hiba: " + error.message;
    }

    async function testSupabase(){
      const out = document.getElementById("login-output");
      if (out) out.textContent = "‚è≥ Supabase kapcsolat teszt indul...";

      try{
        const { data: sessionData, error: sErr } = await supabaseClient.auth.getSession();
        if (sErr) throw sErr;

        // egy ‚Äú√°rtalmatlan‚Äù olvas√°s: drivers els≈ë 1 sora
        const { data, error } = await supabaseClient.from("drivers").select("id,name").limit(1);
        if (error) throw error;

        const user = sessionData?.session?.user;
        const who = user ? (user.user_metadata?.user_name || user.email || user.id) : "NINCS bejelentkezve";
        if (out) out.innerHTML = "‚úÖ Supabase OK.<br>üë§ User: <b>" + escapeHtml(who) + "</b><br><span class='muted'>drivers rows: " + (data?.length ?? 0) + "</span>";
      }catch(e){
        if (out) out.textContent = "‚ùå Supabase teszt hiba: " + (e?.message || String(e));
      }
    }

    // === RACES LIST ===
    async function loadRaces(){
      const list = document.getElementById("races-list");
      const out = document.getElementById("races-output");
      if (list) list.textContent = "Bet√∂lt√©s...";
      if (out) out.textContent = "‚è≥ Futamok bet√∂lt√©se...";

      const { data: sessionData } = await supabaseClient.auth.getSession();
      if (!sessionData?.session?.user){
        if (list) list.innerHTML = "<div class='line'>‚ö†Ô∏è Jelentkezz be el≈ëbb: <a href='#login' style='color:#fff'>Bel√©p√©s</a></div>";
        if (out) out.textContent = "‚ö†Ô∏è Nem vagy bejelentkezve.";
        return;
      }

      // Itt a leggyakoribb oszlopokkal sz√°molunk: id, round, name, location, race_date
      const { data, error } = await supabaseClient
        .from("races")
        .select("id, round, name, location, race_date")
        .order("round", { ascending: true });

      if (error){
        if (list) list.innerHTML = "<div class='line'>‚ùå Hiba a races olvas√°sn√°l: " + escapeHtml(error.message) + "</div>";
        if (out) out.textContent = "‚ùå Hiba: " + error.message;
        return;
      }

      if (!data || data.length === 0){
        if (list) list.innerHTML = "<div class='line'>‚ö†Ô∏è Nincs futam a <b>public.races</b> t√°bl√°ban. Tegy√©l be demo futamokat SQL-ben.</div>";
        if (out) out.textContent = "‚ö†Ô∏è 0 futam.";
        return;
      }

      if (list) list.innerHTML = "";
      for (const r of data){
        const div = document.createElement("div");
        div.className = "item";
        div.onclick = () => goto("#race=" + r.id);

        const left = document.createElement("div");
        left.innerHTML = "<div class='title'>#" + (r.round ?? "?") + " ‚Ä¢ " + escapeHtml(r.name ?? "Futam") + "</div>"
          + "<div class='muted' style='margin-top:2px; font-size:13px;'>" + escapeHtml(r.location ?? "") + "</div>";

        const right = document.createElement("div");
        right.className = "pill";
        right.textContent = r.race_date ? String(r.race_date) : "n/a";

        div.appendChild(left);
        div.appendChild(right);
        if (list) list.appendChild(div);
      }

      if (out) out.textContent = "‚úÖ Futamok bet√∂ltve: " + data.length;
    }

    // === RACE DETAIL + DRAG DROP ===
    let currentRaceId = null;
    let currentDrivers = [];
    let slotsState = [null,null,null,null,null]; // pos1..pos5 -> driver object

    async function openRace(raceId){
      currentRaceId = raceId;
      slotsState = [null,null,null,null,null];

      const title = document.getElementById("race-title");
      const out = document.getElementById("race-output");
      const driversEl = document.getElementById("drivers-list");
      const slotsEl = document.getElementById("slots");
      const adminPanel = document.getElementById("admin-panel");

      if (title) title.textContent = "üèÅ Futam";
      if (out) out.textContent = "‚è≥ Bet√∂lt√©s...";
      if (driversEl) driversEl.textContent = "Bet√∂lt√©s...";
      if (slotsEl) slotsEl.innerHTML = "";

      const { data: sessionData } = await supabaseClient.auth.getSession();
      const user = sessionData?.session?.user;
      if (!user){
        if (out) out.textContent = "‚ö†Ô∏è Jelentkezz be el≈ëbb (#login).";
        return;
      }

      // admin panel kapcsol√≥
      const isAdmin = ADMIN_USER_IDS.includes(user.id);
      if (adminPanel) adminPanel.classList.toggle("hidden", !isAdmin);

      // futam adatok
      const { data: raceRow, error: raceErr } = await supabaseClient
        .from("races")
        .select("id, round, name, location, race_date")
        .eq("id", raceId)
        .maybeSingle();

      if (raceErr){
        if (out) out.textContent = "‚ùå Futam bet√∂lt√©s hiba: " + raceErr.message;
        return;
      }
      if (title && raceRow){
        title.textContent = "üèÅ #" + (raceRow.round ?? "?") + " ‚Ä¢ " + (raceRow.name ?? "Futam")
          + (raceRow.race_date ? " ‚Ä¢ " + raceRow.race_date : "");
      }

      // pil√≥t√°k bet√∂lt√©se
      const { data: drivers, error: dErr } = await supabaseClient
        .from("drivers")
        .select("id, name, team, avatar_url")
        .order("name", { ascending: true });

      if (dErr){
        if (driversEl) driversEl.innerHTML = "<div class='line'>‚ùå Drivers bet√∂lt√©s hiba: " + escapeHtml(dErr.message) + "</div>";
        if (out) out.textContent = "‚ùå Drivers hiba: " + dErr.message;
        return;
      }
      currentDrivers = drivers || [];

      // slot UI
      renderSlots();

      // drivers UI
      renderDrivers();

      // megl√©v≈ë tipp bet√∂lt√©se
      await loadExistingPick();

      if (out) out.textContent = "‚úÖ K√©szen √°ll. H√∫zd be a pil√≥t√°kat, majd mentsd.";
    }

    function renderDrivers(){
      const driversEl = document.getElementById("drivers-list");
      if (!driversEl) return;

      if (!currentDrivers || currentDrivers.length === 0){
        driversEl.innerHTML = "<div class='line'>‚ö†Ô∏è Nincs driver a public.drivers t√°bl√°ban.</div>";
        return;
      }

      driversEl.innerHTML = "";
      for (const d of currentDrivers){
        const div = document.createElement("div");
        div.className = "driver";
        div.draggable = true;
        div.dataset.driverId = d.id;
        div.addEventListener("dragstart", (ev) => {
          ev.dataTransfer.setData("text/plain", d.id);
        });

        const av = document.createElement("div");
        av.className = "avatar";
        if (d.avatar_url){
          const img = document.createElement("img");
          img.src = d.avatar_url;
          img.alt = d.name || "";
          av.appendChild(img);
        } else {
          av.textContent = (d.name || "?").split(" ").map(x=>x[0]).slice(0,2).join("").toUpperCase();
        }

        const txt = document.createElement("div");
        txt.innerHTML = "<b>" + escapeHtml(d.name || "Driver") + "</b>"
          + (d.team ? "<div class='muted' style='font-size:12px; margin-top:2px;'>" + escapeHtml(d.team) + "</div>" : "");

        div.appendChild(av);
        div.appendChild(txt);
        driversEl.appendChild(div);
      }
    }

    function renderSlots(){
      const slotsEl = document.getElementById("slots");
      if (!slotsEl) return;

      slotsEl.innerHTML = "";
      for (let i=0;i<5;i++){
        const pos = i+1;
        const slot = document.createElement("div");
        slot.className = "slot" + (slotsState[i] ? " filled" : "");
        slot.dataset.pos = String(pos);

        slot.addEventListener("dragover", (ev)=>ev.preventDefault());
        slot.addEventListener("drop", (ev)=>{
          ev.preventDefault();
          const driverId = ev.dataTransfer.getData("text/plain");
          const driver = currentDrivers.find(x=>x.id===driverId);
          if (!driver) return;

          // ne legyen duplik√°lt ugyanaz a pil√≥ta t√∂bb helyen
          for (let k=0;k<5;k++){
            if (slotsState[k]?.id === driver.id) slotsState[k] = null;
          }
          slotsState[i] = driver;
          renderSlots();
        });

        const left = document.createElement("div");
        left.innerHTML = "<strong>#" + pos + "</strong>";

        const right = document.createElement("div");
        right.className = "dropHint";
        right.textContent = slotsState[i] ? (slotsState[i].name || "Pilot") : "H√∫zd ide a pil√≥t√°t";

        slot.appendChild(left);
        slot.appendChild(right);

        slotsEl.appendChild(slot);
      }
    }

    function clearSlots(){
      slotsState = [null,null,null,null,null];
      renderSlots();
      const out = document.getElementById("race-output");
      if (out) out.textContent = "üßπ T√∂r√∂lve. H√∫zd be √∫jra.";
    }

    async function loadExistingPick(){
      const out = document.getElementById("race-output");
      const { data: sessionData } = await supabaseClient.auth.getSession();
      const user = sessionData?.session?.user;
      if (!user || !currentRaceId) return;

      // elv√°rt oszlopok a picks t√°bl√°ban: user_id, race_id, position, driver_id
      // ha n√°lad m√°s a n√©v, sz√≥lj √©s √°t√≠rom.
      const { data, error } = await supabaseClient
        .from("picks")
        .select("position, driver_id")
        .eq("user_id", user.id)
        .eq("race_id", currentRaceId);

      if (error){
        if (out) out.textContent = "‚ö†Ô∏è Nem tudtam bet√∂lteni a kor√°bbi tipped: " + error.message;
        return;
      }
      if (!data || data.length === 0) return;

      // bet√∂lt√©s
      slotsState = [null,null,null,null,null];
      for (const row of data){
        const idx = (row.position ?? 0) - 1;
        const driver = currentDrivers.find(x=>x.id === row.driver_id);
        if (idx>=0 && idx<5 && driver) slotsState[idx] = driver;
      }
      renderSlots();
      if (out) out.textContent = "‚úÖ Kor√°bbi tipped bet√∂ltve.";
    }

    async function savePick(){
      const out = document.getElementById("race-output");
      const { data: sessionData } = await supabaseClient.auth.getSession();
      const user = sessionData?.session?.user;
      if (!user){
        if (out) out.textContent = "‚ö†Ô∏è Jelentkezz be el≈ëbb (#login).";
        return;
      }
      if (!currentRaceId){
        if (out) out.textContent = "‚ö†Ô∏è Nincs kiv√°lasztott futam.";
        return;
      }

      // valid√°ci√≥: mind az 5 legyen kit√∂ltve
      for (let i=0;i<5;i++){
        if (!slotsState[i]){
          if (out) out.textContent = "‚ö†Ô∏è T√∂ltsd ki mind az 5 helyet (hi√°nyzik: #" + (i+1) + ").";
          return;
        }
      }

      if (out) out.textContent = "‚è≥ Ment√©s...";

      // T√∂r√∂lj√ºk a r√©gi tippedet erre a futamra, majd besz√∫rjuk √∫jra (MVP)
      const del = await supabaseClient
        .from("picks")
        .delete()
        .eq("user_id", user.id)
        .eq("race_id", currentRaceId);

      if (del.error){
        if (out) out.textContent = "‚ùå R√©gi tipp t√∂rl√©s hiba: " + del.error.message;
        return;
      }

      const rows = slotsState.map((d, idx)=>({
        user_id: user.id,
        race_id: currentRaceId,
        position: idx+1,
        driver_id: d.id
      }));

      const ins = await supabaseClient.from("picks").insert(rows);
      if (ins.error){
        if (out) out.textContent = "‚ùå Ment√©s hiba: " + ins.error.message;
        return;
      }

      if (out) out.textContent = "‚úÖ Tipp elmentve!";
    }

    // === helpers ===
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
  </script>
</body>
</html>
