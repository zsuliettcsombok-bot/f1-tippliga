<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>F1 2026 Tipp Liga</title>
  <link rel="icon" href="data:,">
  <style>
    :root{
      --red:#c40000;
      --red2:#ff2a2a;
      --bg:#050505;
      --panel:#101010;
      --text:#f2f2f2;
      --muted:#bdbdbd;
      --line:#2a2a2a;
      --glow: rgba(255, 0, 0, .22);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:
        radial-gradient(1200px 600px at 25% 15%, rgba(255,0,0,.18), transparent 55%),
        radial-gradient(900px 500px at 70% 30%, rgba(255,0,0,.12), transparent 55%),
        linear-gradient(#000,#050505 25%, #050505);
      color:var(--text);
    }
    .topbar{
      position:sticky; top:0; z-index:10;
      background: linear-gradient(90deg, #7f0000, var(--red));
      border-bottom:1px solid rgba(255,255,255,.06);
      padding:12px 18px;
    }
    .topbar-inner{
      max-width:1200px; margin:0 auto;
      display:flex; align-items:center; gap:14px;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.4px;}
    .brand-pill{
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
      padding:6px 10px;
      border-radius:999px;
      font-size:14px;
    }
    .nav{margin-left:auto; display:flex; gap:10px; flex-wrap:wrap;}
    .nav a{
      text-decoration:none; color:#fff;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 14px;
      border-radius:14px;
      font-weight:800;
    }
    .nav a:hover{ outline:2px solid rgba(255,255,255,.08); }

    .wrap{max-width:1200px; margin:22px auto 60px; padding:0 18px;}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.08);
      border-radius:22px;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      padding:22px;
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(500px 200px at 15% 15%, rgba(255,0,0,.18), transparent 60%);
      pointer-events:none;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
      color:var(--muted);
      font-weight:800;
      margin-bottom:10px;
      position:relative; z-index:1;
    }
    h1{margin:0 0 8px; font-size:44px; line-height:1.05; position:relative; z-index:1;}
    h2{margin:0 0 8px; position:relative; z-index:1;}
    p{position:relative; z-index:1;}
    .lead{margin:0 0 18px; color:#d7d7d7;}
    .muted{color:var(--muted);}
    .actions{display:flex; gap:10px; flex-wrap:wrap; position:relative; z-index:1;}
    .btn{
      cursor:pointer;
      border:none;
      border-radius:14px;
      padding:12px 16px;
      font-weight:900;
      color:#fff;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 12px 28px rgba(0,0,0,.35);
    }
    .btn.primary{
      background: linear-gradient(180deg, var(--red2), #b00000);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 18px 40px var(--glow);
    }
    .btn:hover{ outline:2px solid rgba(255,255,255,.08); }
    .hidden{display:none !important;}
    .line{
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      color:#e8e8e8;
      position:relative; z-index:1;
      word-break: break-word;
      white-space: pre-wrap;
    }
    .foot{margin-top:18px; text-align:center; color:#bdbdbd; opacity:.9; font-size:14px;}

    .race-list{display:flex; flex-direction:column; gap:10px; position:relative; z-index:1;}
    .race-item{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 14px;
      border-radius:14px;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      cursor:pointer;
    }
    .race-item:hover{ outline:2px solid rgba(255,255,255,.08); }
    .race-title{font-weight:900;}
    .race-meta{color:var(--muted); font-weight:700; font-size:13px;}

    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px; position:relative; z-index:1;}
    @media(max-width: 980px){ .grid{grid-template-columns:1fr;} }

    .panel{
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:12px;
    }

    .slots{display:flex; flex-direction:column; gap:10px; margin-top:10px;}
    .slot{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 12px;
      border-radius:14px;
      background:rgba(0,0,0,.18);
      border:1px dashed rgba(255,255,255,.18);
      min-height:52px;
    }
    .slot strong{font-size:14px;}
    .slot .hint{color:var(--muted); font-weight:800;}
    .slot.filled{border-style:solid; border-color: rgba(255,255,255,.14);}

    .driver-list{display:flex; flex-direction:column; gap:10px; margin-top:10px; max-height:520px; overflow:auto; padding-right:4px;}
    .driver{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 10px;
      border-radius:14px;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      cursor:grab;
    }
    .driver:active{cursor:grabbing;}
    .d-left{display:flex; align-items:center; gap:10px;}
    .avatar{
      width:36px; height:36px; border-radius:999px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      flex:0 0 auto;
    }
    .avatar img{width:100%; height:100%; object-fit:cover; display:block;}
    .d-name{font-weight:900;}
    .d-team{color:var(--muted); font-weight:800; font-size:12px;}

    .config-row{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .inp{
      flex:1 1 280px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.25);
      color:#fff;
      outline:none;
    }
    .small{font-size:13px;}
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <span class="brand-pill">F1</span>
        <span>2026 TIPP LIGA</span>
      </div>
      <nav class="nav">
        <a href="#home">Kezd≈ë</a>
        <a href="#races">Versenynapt√°r</a>
        <a href="#rank">Ranglista</a>
        <a href="#login">Bel√©p√©s</a>
      </nav>
    </div>
  </header>

  <main class="wrap">

    <section id="view-home">
      <div class="card">
        <div class="badge">üèÅ MVP ‚Ä¢ Futamlista ‚Üí Tipp oldal (drag & drop)</div>
        <h1>F1 2026 Tipp Liga</h1>
        <p class="lead">F≈ëoldalon futamnapt√°r. Futamot kiv√°lasztva k√ºl√∂n Tipp oldalon h√∫zod be az 1‚Äì5. helyre a pil√≥t√°kat. Ment√©s Supabase-be.</p>
        <div class="actions">
          <button class="btn primary" onclick="goto('#races')">üìÖ Versenynapt√°r</button>
          <button class="btn" onclick="goto('#login')">üöÄ Bel√©p√©s</button>
          <button class="btn" onclick="hardReload()">üîÅ Friss√≠t√©s</button>
        </div>

        <div class="line" id="home-auth-line">üîí St√°tusz: <span class="muted">ellen≈ërz√©s...</span></div>
      </div>
      <div class="foot">¬© F1 Tipp Liga 2026 ‚Ä¢ GitHub Pages ‚Ä¢ Supabase</div>
    </section>

    <section id="view-races" class="hidden">
      <div class="card">
        <h2>üìÖ Versenynapt√°r</h2>
        <p class="muted">Kattints egy futamra ‚Üí √°tvisz a Tipp oldalra.</p>

        <div class="actions" style="margin-top:12px;">
          <button class="btn" onclick="goto('#home')">‚¨ÖÔ∏è Vissza</button>
          <button class="btn primary" onclick="loadRaces(true)">üîÑ Lista friss√≠t√©se</button>
        </div>

        <div class="line" id="races-status">Bet√∂lt√©s...</div>
        <div class="race-list" id="races-list" style="margin-top:12px;"></div>
      </div>
      <div class="foot">¬© F1 Tipp Liga 2026 ‚Ä¢ GitHub Pages ‚Ä¢ Supabase</div>
    </section>

    <section id="view-pick" class="hidden">
      <div class="card">
        <h2>üß≤ Tipp oldal (drag & drop)</h2>
        <div class="muted" id="pick-race-title">Futam: bet√∂lt√©s...</div>

        <div class="actions" style="margin-top:12px;">
          <button class="btn" onclick="goto('#races')">‚¨ÖÔ∏è Vissza a futamokhoz</button>
          <button class="btn" onclick="clearSlots()">üßπ T√∂rl√©s</button>
          <button class="btn" onclick="deletePick()">üóë Tipp t√∂rl√©se</button>
          <button class="btn primary" onclick="savePick()">üíæ Tipp ment√©se</button>
        </div>

        <div class="grid" style="margin-top:14px;">
          <div class="panel">
            <div style="font-weight:900;">Helyez√©sek (1‚Äì5)</div>
            <div class="slots" id="slots"></div>
            <div class="line" id="pick-status">K√©szen √°ll.</div>
          </div>

          <div class="panel">
            <div style="font-weight:900;">Pil√≥t√°k</div>
            <div class="muted">H√∫zd a pil√≥t√°t egy helyre.</div>
            <div class="driver-list" id="drivers-list">Bet√∂lt√©s...</div>
          </div>
        </div>
      </div>
      <div class="foot">¬© F1 Tipp Liga 2026 ‚Ä¢ GitHub Pages ‚Ä¢ Supabase</div>
    </section>

    <section id="view-rank" class="hidden">
      <div class="card">
        <h2>üìä Ranglista (MVP)</h2>
        <p class="muted">√ñsszes tipp + eredm√©nyek alapj√°n pontsz√°mol√°s. (MVP: user_id r√∂vid√≠tve.)</p>
        <div class="actions" style="margin-top:12px;">
          <button class="btn" onclick="goto('#home')">‚¨ÖÔ∏è Vissza</button>
          <button class="btn primary" onclick="loadRank(true)">üîÑ Ranglista friss√≠t√©se</button>
        </div>
        <div class="line" id="rank-status">K√©szen √°ll.</div>
        <div class="line" id="rank-output">Bet√∂lt√©s...</div>
      </div>
      <div class="foot">¬© F1 Tipp Liga 2026 ‚Ä¢ GitHub Pages ‚Ä¢ Supabase</div>
    </section>

    <section id="view-login" class="hidden">
      <div class="card">
        <h2>üöÄ Bel√©p√©s</h2>
        <p class="muted">El≈ëbb Supabase kapcsolat, ut√°na GitHub bel√©p√©s. (Session ment≈ëdik localStorage-be.)</p>

        <div class="panel">
          <div style="font-weight:900;">üîß Supabase be√°ll√≠t√°s (csak egyszer)</div>
          <div class="muted small">Ha ma ‚Äúelsz√°llt‚Äù / nem v√°laszol: itt √∫jra megadhatod a Supabase URL-t √©s ANON KEY-t. Ezt a b√∂ng√©sz≈ë elmenti localStorage-be. Nem ker√ºl a chatbe.</div>
          <div class="config-row">
            <input class="inp" id="cfg-url" placeholder="SUPABASE_URL (https://...supabase.co)" />
            <input class="inp" id="cfg-key" placeholder="SUPABASE_ANON_KEY (eyJ...)" />
          </div>
          <div class="actions" style="margin-top:10px;">
            <button class="btn" onclick="saveConfig()">üíæ Ment√©s a b√∂ng√©sz≈ëbe</button>
            <button class="btn" onclick="clearConfig()">üßπ T√∂rl√©s (reset)</button>
            <button class="btn primary" onclick="reinitSupabase()">‚ôªÔ∏è √öjrainicializ√°l√°s</button>
          </div>
          <div class="line" id="cfg-status">K√©szen √°ll.</div>
        </div>

        <div class="actions" style="margin-top:12px;">
          <button class="btn primary" onclick="testSupabase()">‚úÖ Supabase kapcsolat teszt</button>
          <button class="btn" onclick="loginWithGithub()">üêô GitHub bel√©p√©s</button>
          <button class="btn" onclick="logout()">üö™ Kijelentkez√©s</button>
          <button class="btn" onclick="goto('#home')">‚¨ÖÔ∏è Vissza</button>
        </div>

        <div id="login-output" class="line muted">K√©szen √°ll.</div>
      </div>
      <div class="foot">¬© F1 Tipp Liga 2026 ‚Ä¢ GitHub Pages ‚Ä¢ Supabase</div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ====== Supabase config (nem kell a f√°jlban kulcsot ≈ërizgetni) ======
    const LS_URL_KEY = "F1_SUPABASE_URL";
    const LS_ANON_KEY = "F1_SUPABASE_ANON_KEY";

    // Ha te akarsz fixen a f√°jlban tartani √©rt√©ket, ide be√≠rhatod k√©s≈ëbb.
    // Most sz√°nd√©kosan √ºres: a b√∂ng√©sz≈ëb≈ël fogjuk t√∂lteni.
    let SUPABASE_URL = "";
    let SUPABASE_ANON_KEY = "";

    function loadConfigIntoVars(){
      const u = (window.localStorage.getItem(LS_URL_KEY) || "").trim();
      const k = (window.localStorage.getItem(LS_ANON_KEY) || "").trim();
      SUPABASE_URL = u || SUPABASE_URL;
      SUPABASE_ANON_KEY = k || SUPABASE_ANON_KEY;
    }

    function fillConfigUI(){
      const u = document.getElementById("cfg-url");
      const k = document.getElementById("cfg-key");
      if (u) u.value = window.localStorage.getItem(LS_URL_KEY) || "";
      if (k) k.value = window.localStorage.getItem(LS_ANON_KEY) || "";
    }

    function saveConfig(){
      const u = (document.getElementById("cfg-url")?.value || "").trim();
      const k = (document.getElementById("cfg-key")?.value || "").trim();
      const st = document.getElementById("cfg-status");
      if (!u || !k){
        if (st) st.textContent = "‚ö†Ô∏è Add meg mindkett≈ët (URL + ANON KEY), k√ºl√∂nben nem tud csatlakozni.";
        return;
      }
      window.localStorage.setItem(LS_URL_KEY, u);
      window.localStorage.setItem(LS_ANON_KEY, k);
      if (st) st.textContent = "‚úÖ Elmentve localStorage-be.";
    }

    function clearConfig(){
      window.localStorage.removeItem(LS_URL_KEY);
      window.localStorage.removeItem(LS_ANON_KEY);
      fillConfigUI();
      const st = document.getElementById("cfg-status");
      if (st) st.textContent = "üßπ T√∂r√∂lve. Most √∫jra be kell √≠rni.";
    }

    // ====== Supabase client init ======
    let supabaseClient = null;

    function initSupabase(){
      loadConfigIntoVars();
      if (!SUPABASE_URL || !SUPABASE_ANON_KEY){
        supabaseClient = null;
        return;
      }
      supabaseClient = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY,
        {
          auth: {
            persistSession: true,
            autoRefreshToken: true,
            storage: window.localStorage
          }
        }
      );
    }

    function reinitSupabase(){
      initSupabase();
      const st = document.getElementById("cfg-status");
      if (!supabaseClient){
        if (st) st.textContent = "‚ö†Ô∏è Nincs Supabase config (URL/KEY). √çrd be √©s mentsd el.";
      } else {
        if (st) st.textContent = "‚úÖ Supabase √∫jrainicializ√°lva.";
      }
    }

    // ====== app nav ======
    function goto(hash){ location.hash = hash; }

    function hardReload(){
      const u = new URL(window.location.href);
      u.searchParams.set("v", String(Date.now()));
      window.location.href = u.toString();
    }

    function showView(name){
      const views = ["home","races","pick","rank","login"];
      for (const v of views){
        const el = document.getElementById("view-" + v);
        if (el) el.classList.toggle("hidden", v !== name);
      }
      if (name === "login"){
        fillConfigUI();
        reinitSupabase();
      }
    }

    function getHashBase(){
      const h = (location.hash || "#home").replace("#","");
      if (h.startsWith("pick")) return "pick";
      if (h.startsWith("races")) return "races";
      if (h.startsWith("rank")) return "rank";
      if (h.startsWith("login")) return "login";
      return "home";
    }

    function getQueryFromHash(){
      const raw = (location.hash || "#home").slice(1);
      const qIndex = raw.indexOf("?");
      if (qIndex === -1) return new URLSearchParams();
      return new URLSearchParams(raw.slice(qIndex+1));
    }

    async function route(){
      const base = getHashBase();
      showView(base);
      await refreshHomeAuthLine();
      if (base === "races") await loadRaces(false);
      if (base === "pick") await openPickFromHash();
      if (base === "rank") await loadRank(false);
    }

    window.addEventListener("hashchange", route);

    // ====== Auth UI ======
    async function refreshHomeAuthLine(){
      const el = document.getElementById("home-auth-line");
      if (!el) return;

      if (!supabaseClient){
        el.innerHTML = "‚ö†Ô∏è St√°tusz: <span class='muted'>nincs Supabase be√°ll√≠tva</span> (Bel√©p√©s men√º ‚Üí add meg URL/KEY)";
        return;
      }

      const { data } = await supabaseClient.auth.getSession();
      const session = data?.session;

      if (session?.user){
        const name = session.user.user_metadata?.user_name || session.user.email || session.user.id;
        el.innerHTML = "üîì St√°tusz: <b>bejelentkezve</b> ‚Äì " + name;
      } else {
        el.innerHTML = "üîí St√°tusz: <span class='muted'>nincs bejelentkezve</span>";
      }
    }

    async function loginWithGithub(){
      const out = document.getElementById("login-output");
      if (!supabaseClient){
        if (out) out.textContent = "‚ö†Ô∏è El≈ëbb √°ll√≠tsd be a Supabase URL/KEY-t (fent).";
        return;
      }
      if (out) out.textContent = "‚è≥ GitHub bel√©p√©s ind√≠t√°sa...";

      // GitHub Pages alatti path fix (nem kell k√©zzel √≠rogatni)
      const redirectTo = window.location.origin + window.location.pathname;

      const { error } = await supabaseClient.auth.signInWithOAuth({
        provider: "github",
        options: { redirectTo }
      });

      if (error && out) out.textContent = "‚ùå GitHub login hiba: " + error.message;
    }

    async function logout(){
      const out = document.getElementById("login-output");
      if (!supabaseClient){
        if (out) out.textContent = "‚ö†Ô∏è Nincs Supabase inicializ√°lva.";
        return;
      }
      if (out) out.textContent = "‚è≥ Kijelentkez√©s...";
      const { error } = await supabaseClient.auth.signOut();
      if (error && out) out.textContent = "‚ùå Kijelentkez√©s hiba: " + error.message;
      if (!error && out) out.textContent = "‚ÑπÔ∏è Kijelentkezve";
      await refreshHomeAuthLine();
    }

    // ====== HARD Supabase test (timeout + konkret hiba) ======
    async function testSupabase(){
      const out = document.getElementById("login-output");
      if (out) out.textContent = "‚è≥ Supabase teszt...";

      if (!supabaseClient){
        if (out) out.textContent = "‚ö†Ô∏è Nincs Supabase inicializ√°lva. (Bel√©p√©s ‚Üí √≠rd be URL/KEY ‚Üí Ment√©s ‚Üí √öjrainicializ√°l√°s)";
        return;
      }

      const withTimeout = (p, ms=8000) =>
        Promise.race([
          p,
          new Promise((_, rej) => setTimeout(() => rej(new Error("Timeout 8s ‚Äì nincs v√°lasz (blokkol√°s / h√°l√≥zat / CORS)")), ms))
        ]);

      try{
        const races = await withTimeout(
          supabaseClient.from("races").select("id", { count:"exact", head:false }).limit(1),
          8000
        );
        if (races.error) throw new Error("races: " + races.error.message);

        const drivers = await withTimeout(
          supabaseClient.from("drivers").select("id", { count:"exact", head:false }).limit(1),
          8000
        );
        if (drivers.error) throw new Error("drivers: " + drivers.error.message);

        if (out) out.textContent = "‚úÖ Supabase OK (races + drivers el√©rhet≈ë).";
      }catch(e){
        if (out) out.textContent = "‚ùå Supabase teszt hiba: " + (e?.message || String(e));
      }
    }

    // ====== Races list ======
    async function loadRaces(){
      const status = document.getElementById("races-status");
      const list = document.getElementById("races-list");
      if (!status || !list) return;

      if (!supabaseClient){
        status.textContent = "‚ö†Ô∏è Nincs Supabase be√°ll√≠tva. Menj Bel√©p√©s ‚Üí add meg URL/KEY.";
        list.innerHTML = "";
        return;
      }

      status.textContent = "‚è≥ Futamok bet√∂lt√©se...";
      list.innerHTML = "";

      try{
        const res = await supabaseClient
          .from("races")
          .select("id, round, name, location, start_date, end_date")
          .order("round", { ascending:true })
          .limit(200);

        if (res.error) throw res.error;

        const rows = res.data || [];
        if (rows.length === 0){
          status.textContent = "‚ö†Ô∏è Nincs futam a races t√°bl√°ban.";
          return;
        }

        status.textContent = "‚úÖ Futamok bet√∂ltve: " + rows.length;

        for (const r of rows){
          const div = document.createElement("div");
          div.className = "race-item";
          div.onclick = () => goto("#pick?race=" + encodeURIComponent(r.id));

          const left = document.createElement("div");
          const title = document.createElement("div");
          title.className = "race-title";
          title.textContent = `#${r.round} ‚Ä¢ ${r.name || "Futam"}`;
          const meta = document.createElement("div");
          meta.className = "race-meta";
          const sd = r.start_date ? String(r.start_date) : "";
          const ed = r.end_date ? String(r.end_date) : "";
          meta.textContent = `${r.location || ""}${(sd||ed) ? " ‚Ä¢ " + sd + (ed ? " ‚Üí " + ed : "") : ""}`;
          left.appendChild(title);
          left.appendChild(meta);

          const right = document.createElement("div");
          right.className = "race-meta";
          right.textContent = "Tipp ‚Üí";

          div.appendChild(left);
          div.appendChild(right);
          list.appendChild(div);
        }
      }catch(e){
        status.textContent = "‚ùå Futam bet√∂lt√©si hiba: " + (e?.message || String(e));
      }
    }

    // ====== Pick page ======
    let currentRaceId = null;
    let driversCache = [];
    let slots = [null,null,null,null,null];

    function buildSlotsUI(){
      const el = document.getElementById("slots");
      if (!el) return;
      el.innerHTML = "";

      for (let i=0; i<5; i++){
        const box = document.createElement("div");
        box.className = "slot" + (slots[i] ? " filled" : "");
        box.dataset.pos = String(i);

        box.ondragover = (ev) => { ev.preventDefault(); };
        box.ondrop = (ev) => {
          ev.preventDefault();
          const driverId = ev.dataTransfer.getData("text/driver_id");
          if (!driverId) return;
          setSlot(i, driverId);
        };

        const left = document.createElement("div");
        left.innerHTML = `<strong>#${i+1}</strong>`;

        const right = document.createElement("div");
        if (slots[i]){
          const d = driversCache.find(x => x.id === slots[i]);
          right.textContent = d ? d.name : "(ismeretlen)";
        }else{
          right.className = "hint";
          right.textContent = "H√∫zd ide a pil√≥t√°t";
        }

        box.appendChild(left);
        box.appendChild(right);
        el.appendChild(box);
      }
    }

    function setSlot(pos, driverId){
      for (let i=0; i<slots.length; i++){
        if (slots[i] === driverId) slots[i] = null;
      }
      slots[pos] = driverId;
      buildSlotsUI();
    }

    function clearSlots(){
      slots = [null,null,null,null,null];
      buildSlotsUI();
      const st = document.getElementById("pick-status");
      if (st) st.textContent = "üßπ T√∂r√∂lve (csak k√©perny≈ën).";
    }

    async function openPickFromHash(){
      const q = getQueryFromHash();
      const race = q.get("race");
      currentRaceId = race;

      const title = document.getElementById("pick-race-title");
      const status = document.getElementById("pick-status");
      const driversEl = document.getElementById("drivers-list");

      if (!supabaseClient){
        if (title) title.textContent = "‚ö†Ô∏è Nincs Supabase be√°ll√≠tva. Menj Bel√©p√©s ‚Üí add meg URL/KEY.";
        if (driversEl) driversEl.textContent = "";
        return;
      }

      if (!race){
        if (title) title.textContent = "‚ö†Ô∏è Nincs kiv√°lasztott futam (race id hi√°nyzik).";
        return;
      }

      try{
        const rr = await supabaseClient.from("races")
          .select("id, round, name, location, start_date, end_date")
          .eq("id", race)
          .single();

        if (rr.error) throw rr.error;

        const r = rr.data;
        const sd = r.start_date ? String(r.start_date) : "";
        const ed = r.end_date ? String(r.end_date) : "";
        if (title){
          title.textContent = `Futam: #${r.round} ‚Ä¢ ${r.name} ‚Ä¢ ${r.location || ""} ${sd ? " ‚Ä¢ " + sd + (ed ? " ‚Üí " + ed : "") : ""}`;
        }
      }catch(e){
        if (title) title.textContent = "‚ùå Futam bet√∂lt√©si hiba: " + (e?.message || String(e));
      }

      await loadDrivers();
      slots = [null,null,null,null,null];
      buildSlotsUI();

      const { data } = await supabaseClient.auth.getSession();
      const user = data?.session?.user || null;
      if (user){
        await loadMyPick();
      } else {
        if (status) status.textContent = "‚ÑπÔ∏è Tipp ment√©shez jelentkezz be (Bel√©p√©s men√º).";
      }
    }

    async function loadDrivers(){
      const driversEl = document.getElementById("drivers-list");
      const status = document.getElementById("pick-status");
      if (driversEl) driversEl.textContent = "‚è≥ Pil√≥t√°k bet√∂lt√©se...";

      try{
        const res = await supabaseClient
          .from("drivers")
          .select("id, name, team, avatar_url")
          .order("name", { ascending:true })
          .limit(400);

        if (res.error) throw res.error;

        driversCache = res.data || [];
        if (driversCache.length === 0){
          if (driversEl) driversEl.textContent = "‚ö†Ô∏è Nincs pil√≥ta a drivers t√°bl√°ban.";
          return;
        }

        driversEl.innerHTML = "";
        for (const d of driversCache){
          const row = document.createElement("div");
          row.className = "driver";
          row.draggable = true;
          row.ondragstart = (ev) => {
            ev.dataTransfer.setData("text/driver_id", d.id);
          };

          const left = document.createElement("div");
          left.className = "d-left";

          const av = document.createElement("div");
          av.className = "avatar";
          if (d.avatar_url){
            const img = document.createElement("img");
            img.src = d.avatar_url;
            img.alt = d.name;
            av.appendChild(img);
          }

          const info = document.createElement("div");
          const nm = document.createElement("div");
          nm.className = "d-name";
          nm.textContent = d.name;
          const tm = document.createElement("div");
          tm.className = "d-team";
          tm.textContent = d.team || "";
          info.appendChild(nm);
          info.appendChild(tm);

          left.appendChild(av);
          left.appendChild(info);

          const right = document.createElement("div");
          right.className = "race-meta";
          right.textContent = "H√∫zd ‚Üí";

          row.appendChild(left);
          row.appendChild(right);
          driversEl.appendChild(row);
        }

        if (status) status.textContent = "‚úÖ Pil√≥t√°k bet√∂ltve: " + driversCache.length;
      }catch(e){
        if (driversEl) driversEl.textContent = "‚ùå Pil√≥ta bet√∂lt√©si hiba: " + (e?.message || String(e));
      }
    }

    async function loadMyPick(){
      const status = document.getElementById("pick-status");
      const { data } = await supabaseClient.auth.getSession();
      const user = data?.session?.user;
      if (!user || !currentRaceId) return;

      try{
        const res = await supabaseClient
          .from("picks")
          .select("p1,p2,p3,p4,p5")
          .eq("user_id", user.id)
          .eq("race_id", currentRaceId)
          .maybeSingle();

        if (res.error) throw res.error;

        if (res.data){
          slots = [res.data.p1,res.data.p2,res.data.p3,res.data.p4,res.data.p5].map(x=>x||null);
          buildSlotsUI();
          if (status) status.textContent = "‚úÖ Kor√°bbi tipped bet√∂ltve.";
        }else{
          if (status) status.textContent = "‚ÑπÔ∏è Nincs m√©g mentett tipped erre a futamra.";
        }
      }catch(e){
        if (status) status.textContent = "‚ùå Tipp bet√∂lt√©si hiba: " + (e?.message || String(e));
      }
    }

    async function savePick(){
      const status = document.getElementById("pick-status");
      const { data } = await supabaseClient.auth.getSession();
      const user = data?.session?.user;

      if (!user){
        if (status) status.textContent = "‚ö†Ô∏è Tipp ment√©shez jelentkezz be a Bel√©p√©s men√ºben.";
        goto("#login");
        return;
      }
      if (!currentRaceId){
        if (status) status.textContent = "‚ö†Ô∏è Nincs futam kiv√°lasztva.";
        return;
      }
      if (slots.some(x => !x)){
        if (status) status.textContent = "‚ö†Ô∏è Nem teljes a Top5. T√∂ltsd ki mind az 5 helyet.";
        return;
      }

      if (status) status.textContent = "‚è≥ Tipp ment√©se...";

      try{
        const payload = {
          user_id: user.id,
          race_id: currentRaceId,
          p1: slots[0], p2: slots[1], p3: slots[2], p4: slots[3], p5: slots[4],
          updated_at: new Date().toISOString()
        };

        const res = await supabaseClient
          .from("picks")
          .upsert(payload, { onConflict: "user_id,race_id" });

        if (res.error) throw res.error;

        if (status) status.textContent = "‚úÖ Tipp elmentve!";
      }catch(e){
        if (status) status.textContent =
          "‚ùå Ment√©si hiba: " + (e?.message || String(e)) +
          "\n\nHa azt √≠rja, hogy nincs unique/onConflict: a DB-be kell UNIQUE(user_id, race_id) a picks t√°bl√°ra.";
      }
    }

    async function deletePick(){
      const status = document.getElementById("pick-status");
      const { data } = await supabaseClient.auth.getSession();
      const user = data?.session?.user;

      if (!user){
        if (status) status.textContent = "‚ö†Ô∏è T√∂rl√©shez is be kell jelentkezni.";
        goto("#login");
        return;
      }
      if (!currentRaceId){
        if (status) status.textContent = "‚ö†Ô∏è Nincs futam kiv√°lasztva.";
        return;
      }

      if (status) status.textContent = "‚è≥ Tipp t√∂rl√©se...";

      const res = await supabaseClient
        .from("picks")
        .delete()
        .eq("user_id", user.id)
        .eq("race_id", currentRaceId);

      if (res.error){
        if (status) status.textContent = "‚ùå T√∂rl√©si hiba: " + res.error.message;
        return;
      }

      slots = [null,null,null,null,null];
      buildSlotsUI();
      if (status) status.textContent = "‚úÖ Tipp t√∂r√∂lve a DB-b≈ël is.";
    }

    // ====== Rank ======
    function calcPoints(picksRow, resultRow){
      const p = [picksRow.p1, picksRow.p2, picksRow.p3, picksRow.p4, picksRow.p5];
      const r = [resultRow.r1, resultRow.r2, resultRow.r3, resultRow.r4, resultRow.r5];
      let pts = 0;
      for (let i=0;i<5;i++){
        if (p[i] === r[i]) pts += 3;
        else if (r.includes(p[i])) pts += 1;
      }
      return pts;
    }

    async function loadRank(){
      const out = document.getElementById("rank-output");
      const st = document.getElementById("rank-status");
      if (out) out.textContent = "‚è≥ Bet√∂lt√©s...";

      if (!supabaseClient){
        if (out) out.textContent = "‚ö†Ô∏è Nincs Supabase be√°ll√≠tva. Menj Bel√©p√©s ‚Üí add meg URL/KEY.";
        return;
      }

      try{
        const resR = await supabaseClient.from("results").select("race_id,r1,r2,r3,r4,r5");
        if (resR.error) throw resR.error;
        const results = resR.data || [];

        const resP = await supabaseClient.from("picks").select("user_id,race_id,p1,p2,p3,p4,p5");
        if (resP.error) throw resP.error;
        const picks = resP.data || [];

        if (results.length === 0){
          out.textContent = "‚ö†Ô∏è M√©g nincs eredm√©ny (results t√°bla √ºres).";
          if (st) st.textContent = "K√©szen √°ll.";
          return;
        }

        const byRace = new Map(results.map(r => [r.race_id, r]));
        const scoreByUser = new Map();

        for (const p of picks){
          const r = byRace.get(p.race_id);
          if (!r) continue;
          const pts = calcPoints(p, r);
          scoreByUser.set(p.user_id, (scoreByUser.get(p.user_id) || 0) + pts);
        }

        const rows = Array.from(scoreByUser.entries())
          .map(([user_id, pts]) => ({ user_id, pts }))
          .sort((a,b) => b.pts - a.pts);

        if (rows.length === 0){
          out.textContent = "‚ö†Ô∏è Van eredm√©ny, de m√©g nincs hozz√° tipp.";
          if (st) st.textContent = "K√©szen √°ll.";
          return;
        }

        let txt = "üèÜ Ranglista (MVP)\n\n";
        rows.forEach((r, idx) => {
          const short = r.user_id ? (r.user_id.slice(0,8) + "‚Ä¶") : "ismeretlen";
          txt += `${idx+1}. ${short}  ‚Äî  ${r.pts} pont\n`;
        });

        out.textContent = txt;
        if (st) st.textContent = "‚úÖ Ranglista friss√≠tve.";
      }catch(e){
        out.textContent = "‚ùå Ranglista hiba: " + (e?.message || String(e));
      }
    }

    // ====== boot ======
    (async () => {
      initSupabase();
      await route();
    })();
  </script>
</body>
</html>
