<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>F1 2026 Tipp Liga</title>
  <link rel="icon" href="data:,">
  <style>
    :root{
      --red:#c40000;
      --red2:#ff2a2a;
      --bg:#050505;
      --panel:#101010;
      --text:#f2f2f2;
      --muted:#bdbdbd;
      --line:#2a2a2a;
      --glow: rgba(255, 0, 0, .22);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:
        radial-gradient(1200px 600px at 25% 15%, rgba(255,0,0,.18), transparent 55%),
        radial-gradient(900px 500px at 70% 30%, rgba(255,0,0,.12), transparent 55%),
        linear-gradient(#000,#050505 25%, #050505);
      color:var(--text);
    }
    .topbar{
      position:sticky; top:0; z-index:10;
      background: linear-gradient(90deg, #7f0000, var(--red));
      border-bottom:1px solid rgba(255,255,255,.06);
      padding:12px 18px;
    }
    .topbar-inner{
      max-width:1200px; margin:0 auto;
      display:flex; align-items:center; gap:14px;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.4px;}
    .brand-pill{
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
      padding:6px 10px;
      border-radius:999px;
      font-size:14px;
    }
    .nav{margin-left:auto; display:flex; gap:10px; flex-wrap:wrap;}
    .nav a{
      text-decoration:none; color:#fff;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 14px;
      border-radius:14px;
      font-weight:800;
    }
    .nav a:hover{ outline:2px solid rgba(255,255,255,.08); }

    .wrap{max-width:1200px; margin:22px auto 60px; padding:0 18px;}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.08);
      border-radius:22px;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      padding:22px;
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(500px 200px at 15% 15%, rgba(255,0,0,.18), transparent 60%);
      pointer-events:none;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
      color:var(--muted);
      font-weight:800;
      margin-bottom:10px;
      position:relative; z-index:1;
    }
    h1{margin:0 0 8px; font-size:44px; line-height:1.05; position:relative; z-index:1;}
    h2{margin:0 0 8px; position:relative; z-index:1;}
    p, ul{position:relative; z-index:1;}
    .lead{margin:0 0 18px; color:#d7d7d7;}
    .muted{color:var(--muted);}
    .actions{display:flex; gap:10px; flex-wrap:wrap; position:relative; z-index:1;}
    .btn{
      cursor:pointer;
      border:none;
      border-radius:14px;
      padding:12px 16px;
      font-weight:900;
      color:#fff;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 12px 28px rgba(0,0,0,.35);
    }
    .btn.primary{
      background: linear-gradient(180deg, var(--red2), #b00000);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 18px 40px var(--glow);
    }
    .btn:hover{ outline:2px solid rgba(255,255,255,.08); }
    .hidden{display:none !important;}
    .line{
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      color:#e8e8e8;
      position:relative; z-index:1;
      word-break: break-word;
      white-space: pre-wrap;
    }
    .foot{margin-top:18px; text-align:center; color:#bdbdbd; opacity:.9; font-size:14px;}

    /* list√°k / drag */
    .grid2{display:grid; grid-template-columns: 1.05fr .95fr; gap:18px; position:relative; z-index:1;}
    @media (max-width: 980px){ .grid2{grid-template-columns:1fr;} }

    .list{
      border-radius:18px;
      background:rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.10);
      padding:14px;
      min-height: 140px;
    }
    .item{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      margin:8px 0;
      border-radius:14px;
      background:rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.10);
      cursor:pointer;
    }
    .item:hover{ outline:2px solid rgba(255,255,255,.06); }
    .item small{color:var(--muted); font-weight:800;}
    .pill{
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22);
      color:#fff;
      white-space:nowrap;
    }

    .dropzone{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px;
      margin:10px 0;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.20);
      background:rgba(0,0,0,.18);
      min-height:56px;
    }
    .dropzone.dragover{ outline:2px solid rgba(255,255,255,.14); }
    .drop-left{font-weight:900;}
    .drop-right{color:var(--muted); font-weight:900;}
    .driver-chip{
      display:inline-flex; align-items:center; gap:10px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22);
      font-weight:900;
      cursor:grab;
      user-select:none;
    }
    .chip-x{
      border:none; cursor:pointer;
      background:rgba(255,255,255,.10);
      color:#fff;
      border-radius:10px;
      padding:2px 8px;
      font-weight:900;
    }
  </style>
</head>

<body>
<header class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <span class="brand-pill">F1</span>
      <span>2026 TIPP LIGA</span>
    </div>

    <nav class="nav">
      <a href="#home">Kezd≈ë</a>
      <a href="#races">Versenynapt√°r</a>
      <a href="#rank">Ranglista</a>
      <a href="#login">Bel√©p√©s</a>
    </nav>
  </div>
</header>

<main class="wrap">

  <!-- HOME -->
  <section id="view-home">
    <div class="card">
      <div class="badge">üèÅ MVP ‚Ä¢ F≈ëoldal: csak futamlista ‚Üí futam kiv√°laszt√°s ut√°n Tipp oldal</div>
      <h1>F1 2026 Tipp Liga</h1>
      <p class="lead">F≈ëoldalon a versenynapt√°r. Kattints futamra ‚Üí Tipp oldalon h√∫zd be a Top5 pil√≥t√°kat. Ment√©s Supabase-be.</p>
      <div class="actions">
        <button class="btn primary" onclick="goto('#races')">üìÖ Versenynapt√°r</button>
        <button class="btn" onclick="goto('#login')">üöÄ Bel√©p√©s</button>
        <button class="btn" onclick="refreshAll()">üîÑ Friss√≠t√©s</button>
      </div>
      <div class="line" id="home-auth-line">üîí St√°tusz: <span class="muted">ellen≈ërz√©s...</span></div>
    </div>
    <div class="foot">¬© F1 Tipp Liga 2026 ‚Ä¢ GitHub Pages ‚Ä¢ Supabase</div>
  </section>

  <!-- RACES (F≈êOLDAL FUNKCI√ì) -->
  <section id="view-races" class="hidden">
    <div class="card">
      <h2>üìÖ Versenynapt√°r</h2>
      <p class="muted">Kattints egy futamra ‚Üí √°tvisz a Tipp oldalra.</p>

      <div class="actions">
        <button class="btn" onclick="goto('#home')">‚¨ÖÔ∏è Vissza</button>
        <button class="btn primary" onclick="loadRaces()">üîÑ Lista friss√≠t√©se</button>
      </div>

      <div id="races-list" class="list" style="margin-top:14px;">Bet√∂lt√©s...</div>
      <div id="races-status" class="line muted">K√©szen √°ll.</div>
    </div>
  </section>

  <!-- PICK (TIPP OLDAL) -->
  <section id="view-pick" class="hidden">
    <div class="card">
      <h2>üß≤ Tipp (Top5 drag & drop)</h2>
      <p class="muted" id="pick-race-title">Futam: ...</p>

      <div class="actions">
        <button class="btn" onclick="goto('#races')">‚¨ÖÔ∏è Futamlista</button>
        <button class="btn" onclick="clearPick()">üßπ T√∂rl√©s</button>
        <button class="btn primary" onclick="savePick()">üíæ Tipp ment√©se</button>
      </div>

      <div class="grid2" style="margin-top:14px;">
        <div>
          <h3 style="margin:0 0 10px;">Pil√≥t√°k</h3>
          <div id="drivers-list" class="list">Bet√∂lt√©s...</div>
        </div>

        <div>
          <h3 style="margin:0 0 10px;">Top5 helyez√©s</h3>

          <div id="drop-1" class="dropzone" data-pos="1">
            <div class="drop-left">#1</div>
            <div class="drop-right">H√∫zd ide a pil√≥t√°t</div>
          </div>

          <div id="drop-2" class="dropzone" data-pos="2">
            <div class="drop-left">#2</div>
            <div class="drop-right">H√∫zd ide a pil√≥t√°t</div>
          </div>

          <div id="drop-3" class="dropzone" data-pos="3">
            <div class="drop-left">#3</div>
            <div class="drop-right">H√∫zd ide a pil√≥t√°t</div>
          </div>

          <div id="drop-4" class="dropzone" data-pos="4">
            <div class="drop-left">#4</div>
            <div class="drop-right">H√∫zd ide a pil√≥t√°t</div>
          </div>

          <div id="drop-5" class="dropzone" data-pos="5">
            <div class="drop-left">#5</div>
            <div class="drop-right">H√∫zd ide a pil√≥t√°t</div>
          </div>

          <div id="pick-status" class="line muted">K√©szen √°ll.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- RANK -->
  <section id="view-rank" class="hidden">
    <div class="card">
      <h2>üìä Ranglista</h2>
      <div id="rank-output" class="muted">MVP: pontsz√°m√≠t√°s √©s csapatok k√∂vetkez≈ë l√©p√©s.</div>
      <div class="actions" style="margin-top:16px;">
        <button class="btn" onclick="goto('#home')">‚¨ÖÔ∏è Vissza</button>
      </div>
    </div>
  </section>

  <!-- LOGIN -->
  <section id="view-login" class="hidden">
    <div class="card">
      <h2>üöÄ Bel√©p√©s</h2>
      <p class="muted">El≈ëbb tesztelj√ºk a DB-t, ut√°na GitHub bel√©p√©s.</p>

      <div class="actions">
        <button class="btn primary" onclick="testSupabase()">‚úÖ Supabase kapcsolat teszt</button>
        <button class="btn" onclick="loginWithGithub()">üêô GitHub bel√©p√©s</button>
        <button class="btn" onclick="logout()">üö™ Kijelentkez√©s</button>
        <button class="btn" onclick="goto('#home')">‚¨ÖÔ∏è Vissza</button>
      </div>

      <div id="login-output" class="line muted">K√©szen √°ll.</div>
    </div>
  </section>

  <div class="foot">¬© F1 Tipp Liga 2026 ‚Ä¢ GitHub Pages ‚Ä¢ Supabase</div>
</main>

<!-- ===================== SUPABASE ===================== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ‚úÖ A TE ADATAID (ezeket hagyd √≠gy)
  const SUPABASE_URL = "https://mtobtiwoiqqxdkduvjmf.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10b2J0aXdvaXFxeGRrZHV2am1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMTY2NzAsImV4cCI6MjA4MzY5MjY3MH0.qB5tb9uj2GN4iKRvyZnv_lVRZ9xnlgtY3rN6oZV_LDc";

  const supabaseClient = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY,
    {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        storage: window.localStorage
      }
    }
  );

  // Hash navig√°ci√≥
  function goto(hash){ location.hash = hash; }

  function showView(name){
    const views = ["home","races","pick","rank","login"];
    for (const v of views){
      const el = document.getElementById("view-" + v);
      if (el) el.classList.toggle("hidden", v !== name);
    }
  }

  function getHash(){
    return (location.hash || "#home").replace("#","");
  }

  // #pick?race=<uuid>
  function parsePickRaceId(hash){
    // pl: pick?race=xxxx
    const idx = hash.indexOf("?");
    if (idx === -1) return null;
    const base = hash.slice(0, idx);
    if (base !== "pick") return null;
    const qs = new URLSearchParams(hash.slice(idx+1));
    return qs.get("race") || null;
  }

  function route(){
    const h = getHash();
    const pickRaceId = parsePickRaceId(h);

    if (h === "home") showView("home");
    else if (h === "races") showView("races");
    else if (h === "rank") showView("rank");
    else if (h === "login") showView("login");
    else if (h.startsWith("pick") && pickRaceId) showView("pick");
    else showView("home");

    refreshHomeAuthLine();

    if (h === "races") loadRaces();
    if (h.startsWith("pick") && pickRaceId) openPick(pickRaceId);
  }

  window.addEventListener("hashchange", route);

  // Auth √°llapot figyel√©s
  supabaseClient.auth.onAuthStateChange((event) => {
    refreshHomeAuthLine();
    const out = document.getElementById("login-output");
    if (out && event === "SIGNED_IN") out.textContent = "‚úÖ Sikeres bel√©p√©s.";
    if (out && event === "SIGNED_OUT") out.textContent = "‚ÑπÔ∏è Kijelentkezve.";
  });

  // Els≈ë bet√∂lt√©s
  route();

  async function refreshHomeAuthLine(){
    const el = document.getElementById("home-auth-line");
    if (!el) return;

    const { data } = await supabaseClient.auth.getSession();
    const session = data?.session;

    if (session?.user){
      const name = session.user.user_metadata?.user_name || session.user.email || session.user.id;
      el.innerHTML = "üîì St√°tusz: <b>bejelentkezve</b> ‚Äì " + name;
    } else {
      el.innerHTML = "üîí St√°tusz: <span class='muted'>nincs bejelentkezve</span>";
    }
  }

  async function loginWithGithub(){
    const out = document.getElementById("login-output");
    if (out) out.textContent = "‚è≥ GitHub bel√©p√©s ind√≠t√°sa...";

    // GitHub Pages redirect
    const redirectTo = "https://zsuliettcsombok-bot.github.io/f1-tippliga/?auth_callback=1";

    const { error } = await supabaseClient.auth.signInWithOAuth({
      provider: "github",
      options: { redirectTo }
    });

    if (error && out) out.textContent = "‚ùå GitHub login hiba: " + error.message;
  }

  async function logout(){
    const out = document.getElementById("login-output");
    if (out) out.textContent = "‚è≥ Kijelentkez√©s...";
    await supabaseClient.auth.signOut();
    if (out) out.textContent = "‚ÑπÔ∏è Kijelentkezve.";
    goto("#home");
  }

  async function testSupabase(){
    const out = document.getElementById("login-output");
    if (out) out.textContent = "‚è≥ Teszt... (races+drivers SELECT)";

    try{
      const { data: sdata } = await supabaseClient.auth.getSession();
      if (!sdata?.session?.user){
        if (out) out.textContent = "‚ö†Ô∏è Nem vagy bel√©pve. El≈ëbb GitHub bel√©p√©s.";
        return;
      }

      const r = await supabaseClient.from("races").select("id,round,name").limit(3);
      if (r.error){
        if (out) out.textContent = "‚ùå races SELECT hiba: " + r.error.message;
        return;
      }

      const d = await supabaseClient.from("drivers").select("id,name").limit(3);
      if (d.error){
        if (out) out.textContent = "‚ùå drivers SELECT hiba: " + d.error.message;
        return;
      }

      if (out){
        out.textContent =
          "‚úÖ Supabase OK.\n" +
          "races: " + (r.data?.length ?? 0) + " rekord (mutat 3-at)\n" +
          "drivers: " + (d.data?.length ?? 0) + " rekord (mutat 3-at)";
      }
    }catch(e){
      if (out) out.textContent = "‚ùå Teszt hiba: " + (e?.message || e);
    }
  }

  function refreshAll(){
    refreshHomeAuthLine();
    const h = getHash();
    if (h === "races") loadRaces();
    if (h.startsWith("pick")) {
      const id = parsePickRaceId(h);
      if (id) openPick(id);
    }
  }

  // ===================== RACES LISTA =====================
  async function loadRaces(){
    const list = document.getElementById("races-list");
    const status = document.getElementById("races-status");
    if (!list || !status) return;

    list.textContent = "Bet√∂lt√©s...";
    status.textContent = "‚è≥ races lek√©rdez√©s...";

    const { data: sdata } = await supabaseClient.auth.getSession();
    if (!sdata?.session?.user){
      status.textContent = "‚ö†Ô∏è Nem vagy bel√©pve. Menj a Bel√©p√©s men√ºbe √©s l√©pj be GitHub-bal.";
      list.textContent = "‚Äî";
      return;
    }

    const { data, error } = await supabaseClient
      .from("races")
      .select("id, round, name, location, start_date, end_date")
      .order("round", { ascending: true });

    if (error){
      status.textContent = "‚ùå races hiba: " + error.message;
      list.textContent = "‚Äî";
      return;
    }

    if (!data || data.length === 0){
      status.textContent = "‚ö†Ô∏è Nincs futam adat a races t√°bl√°ban.";
      list.textContent = "‚Äî";
      return;
    }

    list.innerHTML = "";
    for (const r of data){
      const el = document.createElement("div");
      el.className = "item";
      const dateTxt = (r.start_date && r.end_date) ? `${r.start_date} ‚Äì ${r.end_date}` : (r.start_date || "");
      el.innerHTML = `
        <div>
          <div style="font-weight:900">#${r.round} ‚Ä¢ ${escapeHtml(r.name || "Futam")}</div>
          <small>${escapeHtml(r.location || "")} ${escapeHtml(dateTxt)}</small>
        </div>
        <span class="pill">Tipp ‚Üí</span>
      `;
      el.onclick = () => goto(`#pick?race=${r.id}`);
      list.appendChild(el);
    }

    status.textContent = `‚úÖ Futamok bet√∂ltve: ${data.length} db`;
  }

  // ===================== PICK (TIPP) =====================
  let CURRENT_RACE_ID = null;
  let CURRENT_USER_ID = null;

  const pickState = { 1:null, 2:null, 3:null, 4:null, 5:null }; // driver objektumok

  async function openPick(raceId){
    CURRENT_RACE_ID = raceId;

    const status = document.getElementById("pick-status");
    const title = document.getElementById("pick-race-title");
    const driversBox = document.getElementById("drivers-list");

    if (status) status.textContent = "‚è≥ Tipp oldal bet√∂lt√©s...";
    if (driversBox) driversBox.textContent = "Bet√∂lt√©s...";

    // auth
    const { data: sdata } = await supabaseClient.auth.getSession();
    const session = sdata?.session;
    if (!session?.user){
      if (status) status.textContent = "‚ö†Ô∏è Nem vagy bel√©pve. Menj Bel√©p√©s ‚Üí GitHub bel√©p√©s.";
      return;
    }
    CURRENT_USER_ID = session.user.id;

    // race adat
    const r = await supabaseClient
      .from("races")
      .select("id, round, name, location, start_date, end_date")
      .eq("id", raceId)
      .maybeSingle();

    if (r.error){
      if (status) status.textContent = "‚ùå Futam lek√©rdez√©s hiba: " + r.error.message;
      return;
    }
    if (title){
      const rr = r.data;
      const dateTxt = (rr?.start_date && rr?.end_date) ? `${rr.start_date} ‚Äì ${rr.end_date}` : (rr?.start_date || "");
      title.textContent = `Futam: #${rr?.round ?? "?"} ‚Ä¢ ${rr?.name ?? ""} ${rr?.location ? "‚Ä¢ " + rr.location : ""} ${dateTxt ? "‚Ä¢ " + dateTxt : ""}`;
    }

    // dropzone eventek
    setupDropzones();

    // drivers lista
    const d = await supabaseClient
      .from("drivers")
      .select("id, name, team, avatar_url")
      .order("name", { ascending: true });

    if (d.error){
      if (status) status.textContent = "‚ùå Drivers hiba: " + d.error.message;
      if (driversBox) driversBox.textContent = "‚Äî";
      return;
    }
    if (!d.data || d.data.length === 0){
      if (status) status.textContent = "‚ö†Ô∏è Nincs pil√≥ta adat a drivers t√°bl√°ban.";
      if (driversBox) driversBox.textContent = "‚Äî";
      return;
    }

    renderDrivers(d.data);

    // el≈ëz≈ë tipp bet√∂lt√©se (ha van)
    await loadExistingPick();

    if (status) status.textContent = "‚úÖ K√©szen √°ll.";
  }

  function setupDropzones(){
    for (let i=1;i<=5;i++){
      const z = document.getElementById(`drop-${i}`);
      if (!z) continue;

      z.ondragover = (e) => { e.preventDefault(); z.classList.add("dragover"); };
      z.ondragleave = () => z.classList.remove("dragover");
      z.ondrop = (e) => {
        e.preventDefault();
        z.classList.remove("dragover");
        const driverJson = e.dataTransfer.getData("application/json");
        if (!driverJson) return;
        const driver = JSON.parse(driverJson);
        setPickPosition(i, driver);
      };
    }
  }

  function renderDrivers(drivers){
    const box = document.getElementById("drivers-list");
    if (!box) return;
    box.innerHTML = "";

    for (const dr of drivers){
      const chip = document.createElement("div");
      chip.className = "driver-chip";
      chip.draggable = true;
      chip.ondragstart = (e) => {
        e.dataTransfer.setData("application/json", JSON.stringify(dr));
      };

      const teamTxt = dr.team ? ` ‚Ä¢ ${dr.team}` : "";
      chip.innerHTML = `<span>${escapeHtml(dr.name)}${escapeHtml(teamTxt)}</span>`;
      box.appendChild(chip);
    }
  }

  function setPickPosition(pos, driver){
    // ne lehessen ugyanazt k√©tszer
    for (let p=1;p<=5;p++){
      if (pickState[p]?.id === driver.id){
        pickState[p] = null;
        renderDropzone(p);
      }
    }

    pickState[pos] = driver;
    renderDropzone(pos);
  }

  function renderDropzone(pos){
    const z = document.getElementById(`drop-${pos}`);
    if (!z) return;

    const left = z.querySelector(".drop-left");
    const right = z.querySelector(".drop-right");

    if (pickState[pos]){
      const dr = pickState[pos];
      right.innerHTML = `
        <span class="pill">${escapeHtml(dr.name)}</span>
        <button class="chip-x" onclick="removePick(${pos})">x</button>
      `;
    } else {
      right.textContent = "H√∫zd ide a pil√≥t√°t";
    }
    if (left) left.textContent = `#${pos}`;
  }

  function removePick(pos){
    pickState[pos] = null;
    renderDropzone(pos);
  }

  function clearPick(){
    for (let i=1;i<=5;i++){
      pickState[i] = null;
      renderDropzone(i);
    }
    const status = document.getElementById("pick-status");
    if (status) status.textContent = "üßπ T√∂r√∂lve.";
  }

  async function loadExistingPick(){
    const status = document.getElementById("pick-status");
    if (status) status.textContent = "‚è≥ Kor√°bbi tipp bet√∂lt√©se...";

    const { data, error } = await supabaseClient
      .from("picks")
      .select("position, driver_id, drivers:driver_id(id,name,team,avatar_url)")
      .eq("race_id", CURRENT_RACE_ID)
      .eq("user_id", CURRENT_USER_ID);

    if (error){
      if (status) status.textContent = "‚ö†Ô∏è Tipp bet√∂lt√©s hiba: " + error.message;
      return;
    }

    // reset
    for (let i=1;i<=5;i++){ pickState[i]=null; renderDropzone(i); }

    if (data && data.length > 0){
      for (const row of data){
        const pos = Number(row.position);
        const dr = row.drivers;
        if (pos>=1 && pos<=5 && dr) pickState[pos] = dr;
      }
      for (let i=1;i<=5;i++) renderDropzone(i);
      if (status) status.textContent = "‚úÖ Kor√°bbi tipp bet√∂ltve.";
    } else {
      if (status) status.textContent = "‚ÑπÔ∏è Nincs m√©g elmentett tipped erre a futamra.";
    }
  }

  async function savePick(){
    const status = document.getElementById("pick-status");
    if (status) status.textContent = "‚è≥ Ment√©s...";

    const { data: sdata } = await supabaseClient.auth.getSession();
    const session = sdata?.session;
    if (!session?.user){
      if (status) status.textContent = "‚ö†Ô∏è Nem vagy bel√©pve.";
      return;
    }

    // ellen≈ërz√©s: mind az 5 poz√≠ci√≥ megvan?
    for (let i=1;i<=5;i++){
      if (!pickState[i]){
        if (status) status.textContent = `‚ö†Ô∏è Hi√°nyzik a #${i} poz√≠ci√≥. T√∂ltsd ki mind az 5-√∂t!`;
        return;
      }
    }

    // t√∂r√∂lj√ºk a r√©gi sorokat √©s √∫jra besz√∫rjuk (egyszer≈± MVP)
    const del = await supabaseClient
      .from("picks")
      .delete()
      .eq("race_id", CURRENT_RACE_ID)
      .eq("user_id", session.user.id);

    if (del.error){
      if (status) status.textContent = "‚ùå R√©gi tipp t√∂rl√©s hiba: " + del.error.message;
      return;
    }

    const rows = [];
    for (let i=1;i<=5;i++){
      rows.push({
        user_id: session.user.id,
        race_id: CURRENT_RACE_ID,
        position: i,
        driver_id: pickState[i].id
      });
    }

    const ins = await supabaseClient.from("picks").insert(rows);
    if (ins.error){
      if (status) status.textContent = "‚ùå Ment√©s hiba: " + ins.error.message;
      return;
    }

    if (status) status.textContent = "‚úÖ Tipp elmentve!";
  }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
</script>
</body>
</html>
